<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HE Cut Pro v18 — Real Assembly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    html,body{font-family:Cairo,system-ui,ui-sans-serif;}
    svg,svg *{user-select:none}
    body{min-height:100vh;transition:background .3s,color .3s}
    body.theme-dark{
      background:
        radial-gradient(circle at top left,rgba(56,189,248,.2),transparent 55%),
        radial-gradient(circle at bottom right,rgba(129,140,248,.25),#020617);
      color:#e5e7eb
    }
    body.theme-light{background:#ffffff;color:#111827}
    .glass{backdrop-filter:blur(20px)}
    body.theme-dark .glass{background:rgba(15,23,42,.88);border-color:rgba(56,189,248,.35)}
    body.theme-light .glass{background:rgba(255,255,255,.9);border-color:#e5e7eb}
    input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:.5rem;border-radius:999px;background:#020617;outline:none}
    body.theme-light input[type=range]{background:#e5e7eb}
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:999px;
      background:#38bdf8;border:2px solid #fff;box-shadow:0 0 0 4px rgba(56,189,248,.5);cursor:pointer
    }
    .lang-btn{transition:all .2s ease;font-size:.7rem}
    .lang-btn-active{transform:scale(1.05);box-shadow:0 0 0 3px rgba(56,189,248,.4);background:#0f172a}
    .field-label-main{font-weight:600;font-size:.9rem}
    .field-label-sub{font-size:.7rem;opacity:.8}
    .tab-btn-active{background:linear-gradient(to left,#22c55e,#06b6d4);color:#0f172a;font-weight:700}
  </style>
</head>
<body class="text-slate-100 theme-dark">

<!-- Header -->
<header class="border-b border-slate-700/60 bg-slate-900/80 backdrop-blur sticky top-0 z-20">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-bold tracking-tight">
        <span data-i18n="appTitle">HE Cut Pro</span>
        <span class="text-sky-400 text-base align-middle">v18 — Real Assembly</span>
      </h1>
      <p class="text-xs sm:text-sm text-slate-400 mt-0.5" data-i18n="subtitle">
        قص الجناح العلوي والسفلي — عرض القطعة الواحدة + شكل التجميع النهائي (بدون خطوط حمراء)
      </p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Languages -->
      <div class="flex items-center gap-1 bg-slate-900/60 border border-slate-600/70 rounded-xl p-1 text-xs">
        <button class="lang-btn lang-btn-active px-2 py-1 rounded-lg hover:bg-sky-500/20" data-lang="ar">ع</button>
        <button class="lang-btn px-2 py-1 rounded-lg hover:bg-sky-500/20" data-lang="en">EN</button>
        <button class="lang-btn px-2 py-1 rounded-lg hover:bg-sky-500/20" data-lang="de">DE</button>
      </div>
      <!-- Theme -->
      <button id="themeToggle"
              class="w-9 h-9 rounded-full border border-slate-600 flex items-center justify-center text-lg bg-slate-900/70 hover:bg-slate-800"
              title="Toggle theme">☾</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 sm:py-8">

  <!-- Tabs -->
  <div class="mb-4 flex justify-center gap-2">
    <button id="tabSingle"
            class="px-4 py-2 rounded-full border border-slate-500 text-xs sm:text-sm tab-btn-active"
            data-i18n="tabSingle">القطعة الواحدة</button>
    <button id="tabJoint"
            class="px-4 py-2 rounded-full border border-slate-500 text-xs sm:text-sm"
            data-i18n="tabJoint">بعد الجمع</button>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1.1fr)] gap-6">

    <!-- Settings -->
    <section class="glass rounded-2xl shadow-xl shadow-sky-950/50 border p-4 sm:p-5">
      <h2 class="font-semibold text-lg sm:text-xl mb-4" data-i18n="panel1Title">الإعدادات & الحساب</h2>

      <div class="grid grid-cols-2 gap-3 text-sm">

        <!-- Series -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5">
          <span class="field-label-main" data-i18n="seriesLabel">سلسلة المقطع</span>
          <span class="field-label-sub text-slate-400" data-i18n="seriesHint">HEA / HEB / HEM</span>
        </label>
        <select id="series" class="col-span-2 rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2">
          <option value="HEA">HEA</option>
          <option value="HEB" selected>HEB</option>
          <option value="HEM">HEM</option>
        </select>

        <!-- Size -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-1">
          <span class="field-label-main" data-i18n="sizeLabel">المقاس</span>
          <span class="field-label-sub text-slate-400" data-i18n="sizeHint">HE 100 … HE 400</span>
        </label>
        <select id="size" class="col-span-2 rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2"></select>

        <!-- Cut mode -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-1">
          <span class="field-label-main" data-i18n="cutWingsLabel">الأجنحة المعتمدة في الحساب</span>
          <span class="field-label-sub text-slate-400" data-i18n="cutWingsHint">الزاوية تعتمد على فرق القص بين العلوي والسفلي</span>
        </label>
        <div class="col-span-2 flex flex-wrap gap-3 text-xs text-slate-200">
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="top" checked>
            <span data-i18n="cutModeTop">قص على الجناح العلوي</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="bottom">
            <span data-i18n="cutModeBottom">قص على الجناح السفلي</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="both">
            <span data-i18n="cutModeBoth">يدوي (Δtop / Δbottom)</span>
          </label>
        </div>

        <!-- Target angle -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-1">
          <span class="field-label-main" data-i18n="angleLabel">زاوية التجميع المستهدفة θ (درجة)</span>
          <span class="field-label-sub text-slate-400" data-i18n="angleHint">تستخدم فقط لاقتراح قيمة قص مناسبة</span>
        </label>
        <div class="col-span-2 flex items-center gap-3">
          <input id="angleRange" type="range" min="1" max="45" step="0.5" value="30"/>
          <input id="angle" type="number" min="1" max="45" step="0.5" value="30"
                 class="w-16 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 text-center text-xs"/>
          <span class="text-xs">°</span>
        </div>

        <!-- Cuts -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-1">
          <span class="field-label-main" data-i18n="deltaSectionLabel">قص الجناح (لكل قطعة قبل الجمع) mm</span>
        </label>
        <div>
          <div class="text-xs text-slate-400 mb-1" data-i18n="deltaTopLabel">قص الجناح العلوي Δtop</div>
          <input id="deltaTop" type="number" min="0" step="0.1" value="0"
                 class="w-full rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 text-center text-xs"/>
          <input id="deltaTopRange" type="range" min="0" max="200" step="0.5" value="0" class="mt-1"/>
        </div>
        <div>
          <div class="text-xs text-slate-400 mb-1" data-i18n="deltaBottomLabel">قص الجناح السفلي Δbottom</div>
          <input id="deltaBottom" type="number" min="0" step="0.1" value="0"
                 class="w-full rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 text-center text-xs"/>
          <input id="deltaBottomRange" type="range" min="0" max="200" step="0.5" value="0" class="mt-1"/>
        </div>

        <!-- Cut line tilt -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-2">
          <span class="field-label-main" data-i18n="slopeSectionLabel">شكل القص في الرسم (من العمودي)</span>
          <span class="field-label-sub text-slate-400" data-i18n="slopeSectionHint">0° = قص مستقيم، قيم أكبر = قص مائل (تمثيلي)</span>
        </label>
        <div class="col-span-2 grid grid-cols-2 gap-3 text-xs">
          <div>
            <div class="mb-1 text-slate-400" data-i18n="alphaTopTitle">زاوية ميلان الخط العلوي</div>
            <div class="flex items-center gap-2">
              <input id="alphaTopRange" type="range" min="0" max="60" step="1" value="0"/>
              <input id="alphaTop" type="number" min="0" max="60" step="1" value="0"
                     class="w-14 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 text-center"/>
              <span>°</span>
            </div>
          </div>
          <div>
            <div class="mb-1 text-slate-400" data-i18n="alphaBottomTitle">زاوية ميلان الخط السفلي</div>
            <div class="flex items-center gap-2">
              <input id="alphaBottomRange" type="range" min="0" max="60" step="1" value="0"/>
              <input id="alphaBottom" type="number" min="0" max="60" step="1" value="0"
                     class="w-14 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 text-center"/>
              <span>°</span>
            </div>
          </div>
        </div>

        <!-- Tilt direction -->
        <label class="col-span-2 text-slate-300 flex flex-col gap-0.5 mt-2">
          <span class="field-label-main" data-i18n="tiltDirSectionLabel">اتجاه الميلان (رسم فقط)</span>
          <span class="field-label-sub text-slate-400" data-i18n="tiltDirSectionHint">لا يغيّر الحسابات الهندسية</span>
        </label>
        <div class="col-span-2 grid grid-cols-2 gap-3 text-xs text-slate-200">
          <div>
            <div class="mb-1" data-i18n="tiltTopLabel">اتجاه ميلان العلوي</div>
            <div class="flex gap-2">
              <label><input type="radio" name="tiltDirTop" value="in" checked> <span data-i18n="tiltIn">نحو الوسط</span></label>
              <label><input type="radio" name="tiltDirTop" value="out"> <span data-i18n="tiltOut">خارج</span></label>
            </div>
          </div>
          <div>
            <div class="mb-1" data-i18n="tiltBottomLabel">اتجاه ميلان السفلي</div>
            <div class="flex gap-2">
              <label><input type="radio" name="tiltDirBottom" value="in" checked> <span data-i18n="tiltIn">نحو الوسط</span></label>
              <label><input type="radio" name="tiltDirBottom" value="out"> <span data-i18n="tiltOut">خارج</span></label>
            </div>
          </div>
        </div>

      </div>

      <!-- Readout -->
      <div id="readout" class="mt-5 rounded-xl border border-slate-700/80 bg-slate-900/70 px-3.5 py-3 text-xs"></div>

      <div class="mt-4 flex gap-2">
        <button id="btnReset"
                class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs border border-slate-600"
                data-i18n="resetBtn">إعادة الضبط</button>
      </div>
      <p class="text-[11px] text-slate-400 mt-3" data-i18n="theoryText">
        الفكرة الهندسية: زاوية التجميع بين قطعتين تعتمد على فرق القص بين الجناح العلوي والسفلي. شكل القص (مائل أو مستقيم) تمثيلي فقط.
      </p>
    </section>

    <!-- Visuals -->
    <section class="glass rounded-2xl shadow-xl shadow-sky-950/50 border p-4 sm:p-5">

      <!-- Single piece view -->
      <div id="viewSingle">
        <h2 class="font-semibold text-lg sm:text-xl mb-4" data-i18n="panel2TitleSingle">الوجه الأمامي — شكل القطعة بعد القص</h2>
        <div class="border border-slate-700/70 rounded-2xl bg-slate-900/70 px-3 py-4 flex items-center justify-center">
          <div id="frontWrapper"></div>
        </div>
        <p class="text-[11px] text-slate-400 mt-2" data-i18n="legendSingle">
          الرسم يوضح المقطع H بعد إزالة الجزء المقطوع من الأجنحة، بدون خطوط حمراء. القياسات الرقمية هي المرجع.
        </p>
      </div>

      <!-- Joint view -->
      <div id="viewJoint" class="hidden">
        <h2 class="font-semibold text-lg sm:text-xl mb-4" data-i18n="panel2TitleJoint">بعد الجمع — رؤية أمامية واقعية</h2>
        <div class="border border-slate-700/70 rounded-2xl bg-slate-900/70 px-3 py-4 flex items-center justify-center">
          <div id="pairWrapper" class="min-h-[220px] w-full flex items-center justify-center"></div>
        </div>
        <p class="text-[11px] text-slate-400 mt-2" data-i18n="pairHint">
          القطعتان تلتقيان عند الأجنحة العلوية المقصوصة مع فراغ صغير جداً، والجناحان السفليان متباعدان حسب زاوية التجميع الناتجة من فرق القص.
        </p>
      </div>

    </section>

  </div>
</main>

<footer class="max-w-6xl mx-auto px-4 pb-6 text-[11px] text-slate-500 flex flex-wrap justify-between gap-2">
  <span data-i18n="footerLeft">HE Cut Pro v18 — Real Assembly</span>
  <span data-i18n="footerRight">للتنفيذ العملي: اعتمد كتالوج المقاطع وتعليمات الورشة.</span>
</footer>

<!-- I18N -->
<script>
  const I18N = {
    ar: {
      appTitle:"HE Cut Pro",
      subtitle:"قص الجناح العلوي والسفلي — عرض القطعة الواحدة + شكل التجميع النهائي (بدون خطوط حمراء)",
      panel1Title:"الإعدادات & الحساب",
      panel2TitleSingle:"الوجه الأمامي — شكل القطعة بعد القص",
      panel2TitleJoint:"بعد الجمع — رؤية أمامية واقعية",
      seriesLabel:"سلسلة المقطع",seriesHint:"HEA / HEB / HEM",
      sizeLabel:"المقاس",sizeHint:"HE 100 … HE 400",
      cutWingsLabel:"الأجنحة المعتمدة في الحساب",
      cutWingsHint:"الزاوية تعتمد على فرق القص بين العلوي والسفلي",
      cutModeTop:"قص على الجناح العلوي",
      cutModeBottom:"قص على الجناح السفلي",
      cutModeBoth:"يدوي (Δtop / Δbottom)",
      angleLabel:"زاوية التجميع المستهدفة θ (درجة)",
      angleHint:"تستخدم فقط لاقتراح قيمة قص مناسبة",
      deltaSectionLabel:"قص الجناح (لكل قطعة قبل الجمع) mm",
      deltaTopLabel:"قص الجناح العلوي Δtop",
      deltaBottomLabel:"قص الجناح السفلي Δbottom",
      slopeSectionLabel:"شكل القص في الرسم (من العمودي)",
      slopeSectionHint:"0° = قص مستقيم، قيم أكبر = قص مائل (تمثيلي)",
      alphaTopTitle:"زاوية ميلان الخط العلوي",
      alphaBottomTitle:"زاوية ميلان الخط السفلي",
      tiltDirSectionLabel:"اتجاه الميلان (رسم فقط)",
      tiltDirSectionHint:"لا يغيّر الحسابات الهندسية",
      tiltTopLabel:"اتجاه ميلان العلوي",
      tiltBottomLabel:"اتجاه ميلان السفلي",
      tiltIn:"نحو الوسط",tiltOut:"خارج",
      resetBtn:"إعادة الضبط",
      theoryText:"الفكرة الهندسية: زاوية التجميع بين قطعتين تعتمد على فرق القص بين الجناح العلوي والسفلي. شكل القص (مائل أو مستقيم) تمثيلي فقط.",
      legendSingle:"الرسم يوضح المقطع H بعد إزالة الجزء المقطوع من الأجنحة، بدون خطوط حمراء. القياسات الرقمية هي المرجع.",
      pairHint:"القطعتان تلتقيان عند الأجنحة العلوية المقصوصة مع فراغ صغير جداً، والجناحان السفليان متباعدان حسب زاوية التجميع الناتجة من فرق القص.",
      footerLeft:"HE Cut Pro v18 — Real Assembly",
      footerRight:"للتنفيذ العملي: اعتمد كتالوج المقاطع وتعليمات الورشة.",
      tabSingle:"القطعة الواحدة",
      tabJoint:"بعد الجمع",
      summaryTitle:"ملخص الحساب",
      profileLabel:"البروفايل",
      flangeWidthLabel:"عرض الجناح b (تقريبي)",
      targetAngleLabel:"زاوية التجميع الناتجة من فرق القص",
      diffCutLabel:"الفرق |Δtop − Δbottom|",
      remainingTopLabel:"العرض المتبقي في الجناح العلوي",
      remainingBottomLabel:"العرض المتبقي في الجناح السفلي",
      pairAngleText:"زاوية التجميع التقريبية بين القطعتين"
    },
    en:{
      appTitle:"HE Cut Pro",
      subtitle:"Top & bottom flange cut — single piece + final assembly (no red lines)",
      panel1Title:"Settings & Calculation",
      panel2TitleSingle:"Front view — piece after cut",
      panel2TitleJoint:"After assembly — realistic front view",
      seriesLabel:"Section series",seriesHint:"HEA / HEB / HEM",
      sizeLabel:"Size",sizeHint:"HE 100 … HE 400",
      cutWingsLabel:"Flanges used in calculation",
      cutWingsHint:"Angle depends on cut difference between top & bottom",
      cutModeTop:"Cut on top flange",
      cutModeBottom:"Cut on bottom flange",
      cutModeBoth:"Manual (Δtop / Δbottom)",
      angleLabel:"Target assembly angle θ (deg)",
      angleHint:"Used only to suggest cut value",
      deltaSectionLabel:"Flange cut (per piece before assembly) mm",
      deltaTopLabel:"Top flange cut Δtop",
      deltaBottomLabel:"Bottom flange cut Δbottom",
      slopeSectionLabel:"Cut shape in drawing (from vertical)",
      slopeSectionHint:"0° = straight cut, larger = sloped (visual only)",
      alphaTopTitle:"Top cut line tilt angle",
      alphaBottomTitle:"Bottom cut line tilt angle",
      tiltDirSectionLabel:"Tilt direction (drawing only)",
      tiltDirSectionHint:"Does not affect geometry",
      tiltTopLabel:"Top tilt direction",
      tiltBottomLabel:"Bottom tilt direction",
      tiltIn:"Towards center",tiltOut:"Outwards",
      resetBtn:"Reset",
      theoryText:"Engineering idea: the assembly angle between two pieces depends on the difference between top and bottom flange cuts. Cut shape (sloped/straight) is visual only.",
      legendSingle:"Single H-beam after removing the cut part, without red lines. Numeric values are reference.",
      pairHint:"Top flanges meet at the cut edges with a tiny gap, bottom flanges are separated according to the angle from cut difference.",
      footerLeft:"HE Cut Pro v18 — Real Assembly",
      footerRight:"For real work: use official section tables and workshop instructions.",
      tabSingle:"Single piece",
      tabJoint:"After assembly",
      summaryTitle:"Calculation summary",
      profileLabel:"Profile",
      flangeWidthLabel:"Flange width b (approx)",
      targetAngleLabel:"Resulting assembly angle from cut diff",
      diffCutLabel:"Difference |Δtop − Δbottom|",
      remainingTopLabel:"Remaining top flange width",
      remainingBottomLabel:"Remaining bottom flange width",
      pairAngleText:"Approximate assembly angle between pieces"
    },
    de:{
      appTitle:"HE Cut Pro",
      subtitle:"Oberer & unterer Flanschschnitt — Einzelteil + Endmontage (ohne rote Linien)",
      panel1Title:"Einstellungen & Berechnung",
      panel2TitleSingle:"Vorderansicht — Profil nach dem Schnitt",
      panel2TitleJoint:"Nach Montage — realistische Vorderansicht",
      seriesLabel:"Profilserie",seriesHint:"HEA / HEB / HEM",
      sizeLabel:"Größe",sizeHint:"HE 100 … HE 400",
      cutWingsLabel:"Flansche in Berechnung",
      cutWingsHint:"Winkel hängt von Schnittdifferenz oben/unten ab",
      cutModeTop:"Schnitt am oberen Flansch",
      cutModeBottom:"Schnitt am unteren Flansch",
      cutModeBoth:"Manuell (Δtop / Δbottom)",
      angleLabel:"Zielmontagewinkel θ (Grad)",
      angleHint:"Nur zur Vorschlag von Schnittwert",
      deltaSectionLabel:"Flanschschnitt (pro Teil vor Montage) mm",
      deltaTopLabel:"Oberer Flanschschnitt Δtop",
      deltaBottomLabel:"Unterer Flanschschnitt Δbottom",
      slopeSectionLabel:"Schnittform in Zeichnung (von vertikal)",
      slopeSectionHint:"0° = gerader Schnitt, größer = geneigt (nur visuell)",
      alphaTopTitle:"Neigungswinkel obere Schnittlinie",
      alphaBottomTitle:"Neigungswinkel untere Schnittlinie",
      tiltDirSectionLabel:"Neigungsrichtung (nur Zeichnung)",
      tiltDirSectionHint:"Ändert Geometrie nicht",
      tiltTopLabel:"Neigungsrichtung oben",
      tiltBottomLabel:"Neigungsrichtung unten",
      tiltIn:"Zur Mitte",tiltOut:"Nach außen",
      resetBtn:"Zurücksetzen",
      theoryText:"Montagewinkel zwischen zwei Teilen hängt von der Differenz zwischen oberen und unteren Flanschschnitten ab. Schnittform (geneigt/gerade) ist nur visuell.",
      legendSingle:"Einzelnes H-Profil nach dem Entfernen des geschnittenen Teils, ohne rote Linien. Maßwerte sind Referenz.",
      pairHint:"Obere Flansche treffen sich an den Schnittkanten mit kleinem Spalt, untere Flansche sind entsprechend dem Winkel getrennt.",
      footerLeft:"HE Cut Pro v18 — Real Assembly",
      footerRight:"Für Praxis: Profilkatalog & Werkstattanweisungen beachten.",
      tabSingle:"Einzelteil",
      tabJoint:"Nach Montage",
      summaryTitle:"Berechnungsübersicht",
      profileLabel:"Profil",
      flangeWidthLabel:"Flanschbreite b (ca.)",
      targetAngleLabel:"Resultierender Montagewinkel aus Schnittdifferenz",
      diffCutLabel:"Differenz |Δtop − Δbottom|",
      remainingTopLabel:"Verbleibende Breite oberer Flansch",
      remainingBottomLabel:"Verbleibende Breite unterer Flansch",
      pairAngleText:"Ungefährer Montagewinkel zwischen Teilen"
    }
  };
</script>

<!-- Logic -->
<script>
  const HE_DATA = {
    HEA:{100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}},
    HEB:{100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}},
    HEM:{100:{b:120},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:260},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}}
  };
  const CALIB = 1.0339;
  const GAP_VISUAL = 4; // فراغ بسيط بصري بين الأجنحة العلوية

  // Elements
  const $series=document.getElementById('series');
  const $size=document.getElementById('size');
  const $angle=document.getElementById('angle');
  const $angleRange=document.getElementById('angleRange');
  const $deltaTop=document.getElementById('deltaTop');
  const $deltaBottom=document.getElementById('deltaBottom');
  const $deltaTopRange=document.getElementById('deltaTopRange');
  const $deltaBottomRange=document.getElementById('deltaBottomRange');
  const $alphaTop=document.getElementById('alphaTop');
  const $alphaTopRange=document.getElementById('alphaTopRange');
  const $alphaBottom=document.getElementById('alphaBottom');
  const $alphaBottomRange=document.getElementById('alphaBottomRange');
  const $readout=document.getElementById('readout');
  const $frontWrapper=document.getElementById('frontWrapper');
  const $pairWrapper=document.getElementById('pairWrapper');
  const $btnReset=document.getElementById('btnReset');
  const $themeToggle=document.getElementById('themeToggle');
  const $tabSingle=document.getElementById('tabSingle');
  const $tabJoint=document.getElementById('tabJoint');
  const $viewSingle=document.getElementById('viewSingle');
  const $viewJoint=document.getElementById('viewJoint');

  let currentLang='ar';
  let mode='angle';

  function getCutMode(){return document.querySelector('input[name="cutWings"]:checked')?.value || 'top';}
  function getTiltDirTop(){return document.querySelector('input[name="tiltDirTop"]:checked')?.value || 'in';}
  function getTiltDirBottom(){return document.querySelector('input[name="tiltDirBottom"]:checked')?.value || 'in';}

  function populateSizes(){
    const s=$series.value;
    const sizes=Object.keys(HE_DATA[s]).map(Number).sort((a,b)=>a-b);
    $size.innerHTML=sizes.map(v=>`<option value="${v}" ${v===180?'selected':''}>${v}</option>`).join('');
  }

  function angleFromCuts(dt,db,b){
    if(b<=0)return 0;
    const diff=Math.abs(dt-db);
    if(diff<0.0001)return 0;
    const half=Math.atan(diff/(CALIB*b));
    return 2*half*180/Math.PI;
  }

  function applyTranslations(lang){
    currentLang=lang;
    const dict=I18N[lang]||I18N.ar;
    document.documentElement.lang=lang;
    document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n');
      if(dict[k]) el.textContent=dict[k];
    });
    document.querySelectorAll('.lang-btn').forEach(b=>{
      b.classList.toggle('lang-btn-active',b.dataset.lang===lang);
    });
    calc();
  }

  function calc(){
    const dict=I18N[currentLang]||I18N.ar;
    const s=$series.value;
    const sz=Number($size.value);
    const cutMode=getCutMode();
    const tiltDirTop=getTiltDirTop();
    const tiltDirBottom=getTiltDirBottom();
    const data=HE_DATA[s][sz]||{b:180};
    const b=data.b;

    const maxCut=Math.round(b*0.7);
    $deltaTopRange.max=maxCut;
    $deltaBottomRange.max=maxCut;

    let angDeg=Number($angle.value);
    let dt=Number($deltaTop.value);
    let db=Number($deltaBottom.value);
    let aTop=Number($alphaTop.value);
    let aBottom=Number($alphaBottom.value);

    if(isNaN(dt))dt=0;if(isNaN(db))db=0;
    if(isNaN(aTop))aTop=0;if(isNaN(aBottom))aBottom=0;
    aTop=Math.max(0,Math.min(60,aTop));
    aBottom=Math.max(0,Math.min(60,aBottom));
    $alphaTop.value=aTop.toFixed(0);$alphaTopRange.value=aTop;
    $alphaBottom.value=aBottom.toFixed(0);$alphaBottomRange.value=aBottom;

    if(mode==='angle'){
      if(!isFinite(angDeg)||angDeg<1)angDeg=1;
      if(angDeg>45)angDeg=45;
      const half=(angDeg*Math.PI/180)/2;
      const base=b*Math.tan(half)*CALIB;
      const dGeom=Math.min(maxCut,base);
      if(cutMode==='top'){dt=dGeom;db=0;}
      else if(cutMode==='bottom'){dt=0;db=dGeom;}
      else{dt=dGeom;db=0;}
    }else{
      dt=Math.max(0,Math.min(dt,maxCut));
      db=Math.max(0,Math.min(db,maxCut));
      angDeg=Math.min(45,Math.max(0,angleFromCuts(dt,db,b)));
    }

    $angle.value=angDeg.toFixed(1);
    $angleRange.value=angDeg;
    $deltaTop.value=dt.toFixed(1);
    $deltaBottom.value=db.toFixed(1);
    $deltaTopRange.value=dt;
    $deltaBottomRange.value=db;

    const pairAngle=angleFromCuts(dt,db,b);
    const remainingTop=Math.max(b-dt,0);
    const remainingBottom=Math.max(b-db,0);
    const diffCut=Math.abs(dt-db);

    const summaryTitle=dict.summaryTitle || 'ملخص الحساب';
    const profileLabel=dict.profileLabel || 'البروفايل';
    const flangeWidthLabel=dict.flangeWidthLabel || 'عرض الجناح b (تقريبي)';
    const targetAngleLabel=dict.targetAngleLabel || 'زاوية التجميع الناتجة من فرق القص';
    const diffCutLabel=dict.diffCutLabel || 'الفرق |Δtop − Δbottom|';
    const remainingTopLabel=dict.remainingTopLabel || 'العرض المتبقي في الجناح العلوي';
    const remainingBottomLabel=dict.remainingBottomLabel || 'العرض المتبقي في الجناح السفلي';
    const pairAngleText=dict.pairAngleText || 'زاوية التجميع التقريبية بين القطعتين';

    $readout.innerHTML = `
      <div class="text-sky-300 mb-1">${summaryTitle}</div>
      <div class="grid grid-cols-2 gap-x-3 gap-y-1">
        <div>${profileLabel}:</div><div class="text-right"><b>${s} ${sz}</b></div>
        <div>${flangeWidthLabel}:</div><div class="text-right"><b>${b.toFixed(0)} mm</b></div>
        <div>${targetAngleLabel}:</div><div class="text-right text-sky-300"><b>${pairAngle.toFixed(2)}°</b></div>
        <div>Δtop:</div><div class="text-right text-emerald-300"><b>${dt.toFixed(1)} mm</b></div>
        <div>Δbottom:</div><div class="text-right text-emerald-300"><b>${db.toFixed(1)} mm</b></div>
        <div>${diffCutLabel}:</div><div class="text-right text-amber-300"><b>${diffCut.toFixed(1)} mm</b></div>
        <div>${remainingTopLabel}:</div><div class="text-right"><b>${remainingTop.toFixed(1)} mm</b></div>
        <div>${remainingBottomLabel}:</div><div class="text-right"><b>${remainingBottom.toFixed(1)} mm</b></div>
      </div>
      <div class="text-[10px] text-slate-400 mt-2">
        ${pairAngleText}: <span class="text-sky-300 font-semibold">${pairAngle.toFixed(2)}°</span>
      </div>
    `;

    renderSinglePiece({s,sz,b,dt,db,aTop,aBottom,tiltDirTop,tiltDirBottom,angleTarget:angDeg});
    renderAssembly({s,sz,b,dt,db,pairAngle});
  }

  // ==== Single piece (front) ====
  function renderSinglePiece({s,sz,b,dt,db,aTop,aBottom,tiltDirTop,tiltDirBottom,angleTarget}){
    const w=340,h=260,pad=30;
    const midX=w/2,topY=pad,botY=h-pad;
    const scale=Math.min(1.1,Math.max(0.7,sz/220));
    const ph=200*scale;
    const flangeTh=Math.max(18,ph*0.18);
    const webTh=Math.max(12,ph*0.12);
    const centerY=(topY+botY)/2;
    const tfy=centerY-ph/2;
    const bfy=centerY+ph/2;
    const halfSpan=70+(b-180)*0.25;
    const fl=midX-halfSpan,fr=midX+halfSpan,fw=fr-fl;

    const remTop=Math.max(b-dt,0);
    const remBottom=Math.max(b-db,0);
    const remTopFrac=remTop/b;
    const remBottomFrac=remBottom/b;

    const topOuterRight=fr;
    const topInnerRight=fl+fw*remTopFrac; // بعد القص
    const bottomOuterRight=fr;
    const bottomInnerRight=fl+fw*remBottomFrac;

    // شكل القص: إذا زاوية =0 ⇒ مستقيم، غير ذلك مائل تمثيلي
    const phiTop=aTop*Math.PI/180;
    const phiBottom=aBottom*Math.PI/180;
    const dirSignTop=tiltDirTop==='in'?-1:1;
    const dirSignBottom=tiltDirBottom==='in'?-1:1;
    const dxTop=Math.tan(phiTop)*flangeTh*dirSignTop;
    const dxBottom=Math.tan(phiBottom)*flangeTh*dirSignBottom;

    const topClipPath = `
      M ${fl} ${tfy}
      H ${topInnerRight}
      L ${topInnerRight+dxTop} ${tfy+flangeTh}
      H ${fl}
      Z
    `;
    const bottomClipPath = `
      M ${fl} ${bfy-flangeTh}
      H ${bottomInnerRight}
      L ${bottomInnerRight+dxBottom} ${bfy}
      H ${fl}
      Z
    `;

    const svg = `
    <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <defs>
        <linearGradient id="mg1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#cbd5f5"/><stop offset="40%" stop-color="#e5e7eb"/>
          <stop offset="70%" stop-color="#9ca3af"/><stop offset="100%" stop-color="#6b7280"/>
        </linearGradient>
        <filter id="sh1" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="#020617" flood-opacity="0.85"/>
        </filter>
        <clipPath id="topFlangeClip">
          <path d="${topClipPath}"/>
        </clipPath>
        <clipPath id="bottomFlangeClip">
          <path d="${bottomClipPath}"/>
        </clipPath>
      </defs>

      <g filter="url(#sh1)">
        <!-- top flange بعد القص -->
        <rect x="${fl}" y="${tfy}" width="${fw}" height="${flangeTh}"
              fill="url(#mg1)" stroke="#94a3b8" stroke-width="1" clip-path="url(#topFlangeClip)"/>
        <!-- bottom flange بعد القص -->
        <rect x="${fl}" y="${bfy-flangeTh}" width="${fw}" height="${flangeTh}"
              fill="url(#mg1)" stroke="#94a3b8" stroke-width="1" clip-path="url(#bottomFlangeClip)"/>
        <!-- web ثابت -->
        <rect x="${midX-webTh/2}" y="${tfy+flangeTh}" width="${webTh}"
              height="${ph-2*flangeTh}" fill="#e5e7eb" stroke="#94a3b8" stroke-width="1"/>
      </g>

      <text x="${midX}" y="${tfy-12}" font-size="13" fill="#e5e7eb" text-anchor="middle" font-weight="600">
        ${s} ${sz}
      </text>
      <text x="${midX}" y="${bfy+20}" font-size="11" fill="#fda4af" text-anchor="middle" font-weight="600">
        θ (target) ≈ ${angleTarget.toFixed(1)}°
      </text>
    </svg>`;
    $frontWrapper.innerHTML = svg;
  }

  // ==== Assembly view ====
  function renderAssembly({s,sz,b,dt,db,pairAngle}){
    const w=420,h=230;
    const cx=w/2, topY=70;
    const bottomY=h-40;
    const angle=Math.min(90,Math.max(0,pairAngle)); // safety
    const half=angle/2;
    const remTop=Math.max(b-dt,0);
    const remBottom=Math.max(b-db,0);

    const scaleTop=0.7;
    const scaleBottom=0.7;
    const topLenPx = 80 + (remTop-180)*0.25*scaleTop;
    const bottomLenPx = 70 + (remBottom-180)*0.25*scaleBottom;

    const webLen=bottomY-topY-20;
    const webTh=10;
    const flangeTh=14;

    const gap=GAP_VISUAL; // pixel gap بين الأجنحة العلوية

    // نصف يسار: نرسم من يمين إلى يسار
    const leftTopStartX = cx - gap/2;
    const leftTopEndX = leftTopStartX - topLenPx;

    const rightTopStartX = cx + gap/2;
    const rightTopEndX = rightTopStartX + topLenPx;

    const leftWebBottomX = leftTopStartX - Math.tan(half*Math.PI/180)*(webLen);
    const rightWebBottomX = rightTopStartX + Math.tan(half*Math.PI/180)*(webLen);

    const leftBottomMidX = leftWebBottomX;
    const rightBottomMidX = rightWebBottomX;

    const leftBottomStartX = leftBottomMidX - bottomLenPx;
    const leftBottomEndX = leftBottomMidX + bottomLenPx*0.1; // قليل للداخل

    const rightBottomStartX = rightBottomMidX - bottomLenPx*0.1;
    const rightBottomEndX = rightBottomMidX + bottomLenPx;

    const angleText = (I18N[currentLang]?.pairAngleText || 'زاوية التجميع التقريبية بين القطعتين') +
      ` ${angle.toFixed(2)}°`;

    const svg = `
    <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <defs>
        <linearGradient id="mg2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#cbd5f5"/><stop offset="40%" stop-color="#e5e7eb"/>
          <stop offset="70%" stop-color="#9ca3af"/><stop offset="100%" stop-color="#6b7280"/>
        </linearGradient>
        <filter id="sh2" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="#020617" flood-opacity="0.85"/>
        </filter>
      </defs>

      <g filter="url(#sh2)">
        <!-- القطعة اليسرى -->
        <!-- الجناح العلوي -->
        <rect x="${leftTopEndX}" y="${topY}"
              width="${leftTopStartX-leftTopEndX}" height="${flangeTh}"
              fill="url(#mg2)" stroke="#94a3b8" stroke-width="1"/>
        <!-- العمود -->
        <polygon points="
          ${leftTopStartX-webTh/2} ${topY+flangeTh}
          ${leftTopStartX+webTh/2} ${topY+flangeTh}
          ${leftWebBottomX+webTh/2} ${bottomY-flangeTh}
          ${leftWebBottomX-webTh/2} ${bottomY-flangeTh}
        " fill="#e5e7eb" stroke="#94a3b8" stroke-width="1"/>
        <!-- الجناح السفلي -->
        <rect x="${leftBottomStartX}" y="${bottomY-flangeTh}"
              width="${leftBottomEndX-leftBottomStartX}" height="${flangeTh}"
              fill="url(#mg2)" stroke="#94a3b8" stroke-width="1"/>

        <!-- القطعة اليمنى -->
        <rect x="${rightTopStartX}" y="${topY}"
              width="${rightTopEndX-rightTopStartX}" height="${flangeTh}"
              fill="url(#mg2)" stroke="#94a3b8" stroke-width="1"/>
        <polygon points="
          ${rightTopStartX-webTh/2} ${topY+flangeTh}
          ${rightTopStartX+webTh/2} ${topY+flangeTh}
          ${rightWebBottomX+webTh/2} ${bottomY-flangeTh}
          ${rightWebBottomX-webTh/2} ${bottomY-flangeTh}
        " fill="#e5e7eb" stroke="#94a3b8" stroke-width="1"/>
        <rect x="${rightBottomStartX}" y="${bottomY-flangeTh}"
              width="${rightBottomEndX-rightBottomStartX}" height="${flangeTh}"
              fill="url(#mg2)" stroke="#94a3b8" stroke-width="1"/>
      </g>

      <!-- نقطة التماس في الأجنحة العلوية -->
      <circle cx="${cx-gap/2}" cy="${topY+flangeTh/2}" r="2.2" fill="#f97373"/>
      <circle cx="${cx+gap/2}" cy="${topY+flangeTh/2}" r="2.2" fill="#f97373"/>

      <!-- قوس الزاوية بين العمودين -->
      <path d="
        M ${cx} ${topY+flangeTh+4}
        A 40 40 0 0 1 ${cx+40*Math.sin(half*Math.PI/180)} ${topY+flangeTh+4+40*(1-Math.cos(half*Math.PI/180))}
      " fill="none" stroke="#f97373" stroke-width="2"/>

      <text x="${w/2}" y="24" font-size="13" fill="#e5e7eb" text-anchor="middle" font-weight="600">
        ${s} ${sz} — Assembly
      </text>
      <text x="${w/2}" y="${h-12}" font-size="10" fill="#cbd5f5" text-anchor="middle">
        ${angleText}
      </text>
    </svg>`;
    $pairWrapper.innerHTML = svg;
  }

  // Events
  [$series,$size].forEach(el=>el.addEventListener('input',()=>{mode='angle';calc();}));
  $angle.addEventListener('input',()=>{mode='angle';calc();});
  $angleRange.addEventListener('input',()=>{$angle.value=$angleRange.value;mode='angle';calc();});
  $deltaTop.addEventListener('change',()=>{mode='cuts';$deltaTopRange.value=$deltaTop.value||0;calc();});
  $deltaBottom.addEventListener('change',()=>{mode='cuts';$deltaBottomRange.value=$deltaBottom.value||0;calc();});
  $deltaTopRange.addEventListener('input',()=>{$deltaTop.value=$deltaTopRange.value;mode='cuts';calc();});
  $deltaBottomRange.addEventListener('input',()=>{$deltaBottom.value=$deltaBottomRange.value;mode='cuts';calc();});
  $alphaTop.addEventListener('input',()=>calc());
  $alphaTopRange.addEventListener('input',()=>{$alphaTop.value=$alphaTopRange.value;calc();});
  $alphaBottom.addEventListener('input',()=>calc());
  $alphaBottomRange.addEventListener('input',()=>{$alphaBottom.value=$alphaBottomRange.value;calc();});

  document.querySelectorAll('input[name="tiltDirTop"],input[name="tiltDirBottom"]').forEach(el=>{
    el.addEventListener('change',()=>calc());
  });

  document.querySelectorAll('input[name="cutWings"]').forEach(el=>{
    el.addEventListener('change',()=>{mode='angle';calc();});
  });

  $btnReset.addEventListener('click',()=>{
    mode='angle';
    $series.value='HEB';populateSizes();$size.value='180';
    $angle.value=30;$angleRange.value=30;
    $deltaTop.value=0;$deltaBottom.value=0;
    $deltaTopRange.value=0;$deltaBottomRange.value=0;
    $alphaTop.value=0;$alphaTopRange.value=0;
    $alphaBottom.value=0;$alphaBottomRange.value=0;
    document.querySelector('input[name="cutWings"][value="top"]').checked=true;
    document.querySelector('input[name="tiltDirTop"][value="in"]').checked=true;
    document.querySelector('input[name="tiltDirBottom"][value="in"]').checked=true;
    calc();
  });

  $themeToggle.addEventListener('click',()=>{
    document.body.classList.toggle('theme-dark');
    document.body.classList.toggle('theme-light');
    $themeToggle.textContent=document.body.classList.contains('theme-dark')?'☾':'☀';
  });

  // Tabs
  $tabSingle.addEventListener('click',()=>{
    $viewSingle.classList.remove('hidden');
    $viewJoint.classList.add('hidden');
    $tabSingle.classList.add('tab-btn-active');
    $tabJoint.classList.remove('tab-btn-active');
  });
  $tabJoint.addEventListener('click',()=>{
    $viewSingle.classList.add('hidden');
    $viewJoint.classList.remove('hidden');
    $tabJoint.classList.add('tab-btn-active');
    $tabSingle.classList.remove('tab-btn-active');
  });

  // Language buttons
  document.querySelectorAll('.lang-btn').forEach(btn=>{
    btn.addEventListener('click',()=>applyTranslations(btn.dataset.lang));
  });

  document.addEventListener('DOMContentLoaded',()=>{
    populateSizes();
    document.getElementById('size').value='180';
    applyTranslations('ar');
  });
</script>

</body>
</html>

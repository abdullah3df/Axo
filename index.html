<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HE Cut Pro v22 — True Joint Geometry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    html,body{ font-family:Cairo,system-ui,ui-sans-serif; }
    svg,svg *{user-select:none}
    body{ min-height:100vh; transition:background .3s,color .3s; }
    body.theme-dark{
      background: radial-gradient(circle at top left,rgba(56,189,248,.2),transparent 55%), radial-gradient(circle at bottom right,rgba(129,140,248,.25),#020617);
      color:#e5e7eb;
    }
    body.theme-light{ background:#f9fafb; color:#111827; }
    .glass{ backdrop-filter:blur(20px); }
    body.theme-dark .glass{ background:rgba(15,23,42,.88); border-color:rgba(56,189,248,.32); }
    body.theme-light .glass{ background:rgba(255,255,255,.9); border-color:#e5e7eb; }
    input[type=range]{ -webkit-appearance:none; appearance:none; width:100%; height:.5rem; border-radius:999px; background:#0f172a; outline:none; }
    body.theme-light input[type=range]{background:#e5e7eb}
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:999px; background:#38bdf8; border:2px solid #fff; box-shadow:0 0 0 4px rgba(56,189,248,.5); cursor:pointer; }
    .lang-btn{ transition:all .18s ease; }
    .lang-btn-active{ background:rgba(56,189,248,.2); color:#e5e7eb; transform:scale(1.05); box-shadow:0 0 0 2px rgba(56,189,248,.5); }
    body.theme-light .lang-btn-active{ color:#0f172a; }
    .tab-btn{ border-radius:999px; padding:.4rem .9rem; font-size:.75rem; display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; border:1px solid transparent; transition:all .16s ease; }
    .tab-btn-active{ background:linear-gradient(135deg,#38bdf8,#a855f7); color:#0f172a; border-color:rgba(15,23,42,.8); box-shadow:0 10px 25px rgba(15,23,42,.4); }
    .view-hidden{display:none;}
  </style>
</head>
<body class="text-slate-100 theme-dark">

<header class="border-b border-slate-700/60 bg-slate-900/85 backdrop-blur sticky top-0 z-20">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-bold tracking-tight flex items-center gap-2">
        <span>HE Cut Pro</span>
        <span class="text-emerald-400 text-sm sm:text-base align-middle">v22 — True Geometry</span>
      </h1>
      <p class="text-xs sm:text-sm text-slate-400 mt-0.5">
        محاكاة هندسية دقيقة لقص وجمع الكمر (HEA/HEB/HEM)
      </p>
    </div>
    <div class="flex items-center gap-3">
      <button id="themeToggle" class="w-9 h-9 rounded-full border border-slate-600 flex items-center justify-center text-lg bg-slate-900/70 hover:bg-slate-800">☾</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 sm:py-10 grid grid-cols-1 lg:grid-cols-[minmax(0,1.05fr)_minmax(0,1.15fr)] gap-6">

  <section class="glass rounded-2xl shadow-xl border border-slate-700/70 p-4 sm:p-5">
    <h2 class="font-semibold text-lg sm:text-xl mb-4 flex items-center gap-2 text-sky-400">
      <span>1. الإعدادات والحساب</span>
    </h2>

    <div class="grid grid-cols-2 gap-3 text-sm">
      <label class="col-span-2 text-slate-300 font-semibold">سلسلة المقطع والمقاس</label>
      <select id="series" class="rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-sky-400">
        <option value="HEA">HEA</option>
        <option value="HEB" selected>HEB</option>
        <option value="HEM">HEM</option>
      </select>
      <select id="size" class="rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-sky-400"></select>

      <label class="col-span-2 text-slate-300 font-semibold mt-2">طريقة القص</label>
      <div class="col-span-2 flex flex-wrap gap-3 text-xs text-slate-200 bg-slate-800/40 p-2 rounded-lg">
        <label class="inline-flex items-center gap-1 cursor-pointer">
          <input type="radio" name="cutWings" value="top" checked class="accent-sky-400">
          <span>قص العلوي (انحناء للأعلى)</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
          <input type="radio" name="cutWings" value="bottom" class="accent-sky-400">
          <span>قص السفلي (انحناء للأسفل)</span>
        </label>
      </div>

      <label class="col-span-2 text-slate-300 font-semibold mt-2 flex justify-between">
        <span>زاوية الانحناء المطلوبة (θ)</span>
        <span id="angleVal" class="text-sky-400">30°</span>
      </label>
      <div class="col-span-2 flex items-center gap-3">
        <input id="angleRange" type="range" min="0" max="90" step="0.5" value="30"/>
      </div>

      <div class="col-span-2 mt-4 p-3 rounded-xl border border-slate-700 bg-slate-900/80 text-xs leading-loose">
        <div class="flex justify-between border-b border-slate-700 pb-1 mb-1">
          <span class="text-slate-400">عرض الجناح (b):</span>
          <span id="resB" class="font-bold">-- mm</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-400">قيمة القص المطلوبة (Δ):</span>
          <span id="resCut" class="text-emerald-400 font-bold text-sm">-- mm</span>
        </div>
        <div class="text-[10px] text-slate-500 mt-1">
          * يتم قص هذه القيمة من طرف الجناح المحدد لجعل القطعتين تطبقان بزاوية <span id="resAng">--</span>.
        </div>
      </div>
    </div>

    <button id="btnReset" class="mt-4 w-full py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs border border-slate-600 transition">إعادة الضبط</button>
  </section>

  <section class="glass rounded-2xl shadow-xl border border-slate-700/70 p-4 sm:p-5 flex flex-col">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-semibold text-lg sm:text-xl text-emerald-400">2. المعاينة الهندسية</h2>
      <div class="bg-slate-900/70 border border-slate-700/80 rounded-full px-1 py-0.5 flex items-center gap-1 text-[11px]">
        <button id="tabSingle" class="tab-btn tab-btn-active">قطعة واحدة</button>
        <button id="tabJoint" class="tab-btn">الجمع (الزاوية)</button>
      </div>
    </div>

    <div class="flex-1 border border-slate-700/70 rounded-2xl bg-[#0f172a] relative overflow-hidden flex items-center justify-center min-h-[300px]">
      <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px); background-size: 20px 20px;"></div>
      
      <div id="canvasWrapper" class="z-10 transition-all duration-500"></div>
    </div>

    <p id="visualHint" class="text-xs text-slate-400 mt-3 text-center">
      حرك شريط الزاوية لترى التأثير.
    </p>
  </section>
</main>

<script>
  const HE_DATA = {
    HEA:{100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300}},
    HEB:{100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300}},
    HEM:{100:{b:120},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:260},300:{b:300}}
  };

  // Elements
  const $series = document.getElementById('series');
  const $size = document.getElementById('size');
  const $angleRange = document.getElementById('angleRange');
  const $angleVal = document.getElementById('angleVal');
  const $resB = document.getElementById('resB');
  const $resCut = document.getElementById('resCut');
  const $resAng = document.getElementById('resAng');
  const $canvasWrapper = document.getElementById('canvasWrapper');
  const $tabSingle = document.getElementById('tabSingle');
  const $tabJoint = document.getElementById('tabJoint');
  const $btnReset = document.getElementById('btnReset');
  const $themeToggle = document.getElementById('themeToggle');

  let currentView = 'single'; // 'single' or 'joint'

  function populateSizes(){
    const s = $series.value;
    const sizes = Object.keys(HE_DATA[s] || {}).map(Number).sort((a,b)=>a-b);
    $size.innerHTML = sizes.map(v=>`<option value="${v}" ${v===180?'selected':''}>${v}</option>`).join('');
  }

  function getState(){
    const s = $series.value;
    const sz = Number($size.value);
    const angle = Number($angleRange.value);
    const cutMode = document.querySelector('input[name="cutWings"]:checked').value;
    
    // Get Profile Data (approximate if missing)
    const data = (HE_DATA[s] && HE_DATA[s][sz]) ? HE_DATA[s][sz] : {b: sz}; 
    const b = data.b;
    
    // Calculate Cut (Delta)
    // Trig: tan(theta/2) = cut / b  ==> cut = b * tan(theta/2)
    // This creates the miter needed on ONE piece to form half the angle, 
    // or the cut on ONE flange to bend the beam.
    // For bending a beam: Gap = b * tan(angle). 
    // We apply half cut to each piece if joining two, OR full cut if bending one.
    // Let's assume we are joining TWO pieces, each cut by half the angle?
    // No, standard practice: To join two beams at 30deg, each is cut at 15deg.
    // The linear cut length (Delta) = width * tan(15deg).
    
    const halfAngleRad = (angle/2) * (Math.PI/180);
    const cutVal = b * Math.tan(halfAngleRad);

    return { s, sz, b, angle, cutMode, cutVal };
  }

  function updateUI(){
    const st = getState();
    $angleVal.textContent = st.angle.toFixed(1) + '°';
    $resB.textContent = st.b + ' mm';
    $resCut.textContent = st.cutVal.toFixed(1) + ' mm';
    $resAng.textContent = st.angle.toFixed(1) + '°';

    if(currentView === 'single') renderSingle(st);
    else renderJoint(st);
  }

  // --- RENDER LOGIC ---

  function renderSingle(st){
    const w = 400, h = 300;
    const cx = w/2, cy = h/2;
    const scale = 0.8; // simple scale
    const H = 160 * scale; // visual height
    const B = (st.b * scale); 
    const flangeTh = 14;
    const webTh = 8;
    
    // Coordinates
    const topY = cy - H/2;
    const botY = cy + H/2;
    const leftX = cx - B/2;
    const rightX = cx + B/2;

    // Calculate Cut Visualization
    // Cut is usually displayed as a chamfer on the profile end in front view
    // But here "Front View" usually implies looking at the 'I' shape.
    // The cut we calculated (Delta) is how much we shorten the flange.
    // Let's visualize the Side Profile of the beam end? 
    // The user asked for Front View of the Joint.
    // Let's draw the Cross Section (I-beam) and lines showing where the cut is.
    
    // Converting 'cutVal' to pixels relative to Width B
    // visualCut = (cutVal / actualWidth) * visualWidth
    const pxCut = (st.cutVal / st.b) * B; 
    
    // Logic: We show the beam face. 
    // If Top Cut: The Top Flange is shorter than the Bottom Flange.
    // In a 2D projection of the face, this looks like the top edge is recessed.
    // To make it clear, let's draw the beam from the SIDE/TOP (Plan/Elevation)?
    // No, the previous app drew the "I" shape. 
    // Let's draw the "I" shape, but indicate the cut with a red line showing the slope.
    
    // Slope line:
    let x1, y1, x2, y2;
    if(st.cutMode === 'top'){
        // Cut is on top. Line goes from (Right - Cut) at Top to (Right) at Bottom.
        // Assuming we keep the bottom length fixed.
        x1 = rightX - pxCut; 
        y1 = topY;
        x2 = rightX;
        y2 = botY;
    } else {
        x1 = rightX;
        y1 = topY;
        x2 = rightX - pxCut;
        y2 = botY;
    }

    const svg = `
      <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">
        <defs>
          <linearGradient id="gradMetal" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#64748b" />
            <stop offset="50%" stop-color="#94a3b8" />
            <stop offset="100%" stop-color="#475569" />
          </linearGradient>
        </defs>
        
        <g transform="translate(0,0)">
           <rect x="${leftX}" y="${topY}" width="${B}" height="${flangeTh}" fill="url(#gradMetal)" stroke="#e2e8f0" stroke-width="1"/>
           <rect x="${leftX}" y="${botY-flangeTh}" width="${B}" height="${flangeTh}" fill="url(#gradMetal)" stroke="#e2e8f0" stroke-width="1"/>
           <rect x="${cx-webTh/2}" y="${topY+flangeTh}" width="${webTh}" height="${H-2*flangeTh}" fill="#cbd5e1" stroke="#94a3b8"/>
        </g>

        <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y1}" stroke="#f43f5e" stroke-width="3" />
        <line x1="${x2}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#f43f5e" stroke-width="3" stroke-dasharray="4 2"/>
        <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#f43f5e" stroke-width="3" />
        
        <path d="M${x1},${y1} L${x2},${y1} L${x2},${y2} L${x1},${y1}" fill="rgba(244, 63, 94, 0.3)" />

        <text x="${cx}" y="${h-20}" fill="#94a3b8" font-size="12" text-anchor="middle">قطعة مفردة - المنطقة الحمراء هي الجزء المزال</text>
        <text x="${rightX}" y="${topY-10}" fill="#f43f5e" font-size="12" text-anchor="end">Δ = ${st.cutVal.toFixed(1)}</text>
      </svg>
    `;
    $canvasWrapper.innerHTML = svg;
  }

  function renderJoint(st){
    // THIS IS THE DEEP FIX
    // We need to draw two beams rotated by angle/2 around a pivot point.
    
    const w = 500, h = 350;
    const cx = w/2, cy = h/2;
    
    const beamLen = 160; // Visual length of one arm
    const H = 100; // Visual Profile Height
    const flangeTh = 12;
    
    // Pivot Logic
    // If we cut TOP flange, the gap is at TOP. They touch at BOTTOM. Pivot = Bottom.
    // If we cut BOTTOM flange, gap is at BOTTOM. Pivot = Top.
    
    let pivotYOffset = 0;
    let rotationDirection = 1; // 1 for bend UP (concave up), -1 for bend DOWN
    
    // Visual correction: 
    // If Cut Mode Top -> Gap at Top -> Beams bend UP relative to flat? No.
    // Imagine a straight beam. Cut wedge from top. Bend ends UP to close gap.
    // So shape is V (like a valley) or ^ (like a roof)?
    // If you remove top material and close gap, the beam bends UP (ends go up, joint goes down). V shape.
    // Let's verify: Length of bottom > Length of top. 
    // Curvature = 1/R. Center of curvature is on the side of the shorter fiber.
    // So Center of curvature is ABOVE the beam. Beam smiles. :)
    
    // Actually simpler:
    // Let's draw them meeting at the pivot.
    
    if(st.cutMode === 'top'){
        pivotYOffset = H/2; // Pivot at Bottom Flange (Since y grows down, cy + H/2)
        // Bends UP. Left beam rotates CW, Right beam rotates CCW?
        // No, to form a "Smile" (Ends up), Left rotates CCW (-ang), Right CW (+ang).
    } else {
        pivotYOffset = -H/2; // Pivot at Top Flange
        // Bends DOWN (Frown). Left rotates CW (+ang), Right CCW (-ang).
    }

    const pivotX = cx;
    const pivotY = cy + pivotYOffset;
    
    const halfAng = st.angle / 2;
    let rotL, rotR;
    
    if(st.cutMode === 'top'){
        rotL = -halfAng; 
        rotR = halfAng;
    } else {
        rotL = halfAng;
        rotR = -halfAng;
    }

    // Helper to draw a beam arm (facing right, origin at bottom-right or top-right based on pivot)
    // We draw it "straight" then rotate the whole group.
    // We need the "Join face" to be at x=0. The beam extends to x = -beamLen (for left) or +beamLen (for right).
    
    const beamColor = "#64748b";
    const cutColor = "#f43f5e"; // color of the joint line
    
    // We will generate SVG groups rotated around (pivotX, pivotY)
    
    const svg = `
      <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">
        <defs>
          <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="4" stdDeviation="5" flood-color="#000" flood-opacity="0.3"/>
          </filter>
        </defs>

        <line x1="${cx}" y1="0" x2="${cx}" y2="${h}" stroke="#334155" stroke-dasharray="4 4" />
        
        <circle cx="${pivotX}" cy="${pivotY}" r="4" fill="#38bdf8" z-index="100"/>

        <g transform="translate(${pivotX}, ${pivotY}) rotate(${rotL})">
            <g transform="translate(-${beamLen}, ${st.cutMode === 'top' ? -H : 0})">
                <rect x="0" y="0" width="${beamLen}" height="${H}" fill="${beamColor}" stroke="#94a3b8" filter="url(#glow)"/>
                <rect x="0" y="0" width="${beamLen}" height="${flangeTh}" fill="#94a3b8" />
                <rect x="0" y="${H-flangeTh}" width="${beamLen}" height="${flangeTh}" fill="#94a3b8" />
                <line x1="0" y1="${H/2}" x2="${beamLen}" y2="${H/2}" stroke="#475569" stroke-dasharray="10 5"/>
                
                <line x1="${beamLen}" y1="0" x2="${beamLen}" y2="${H}" stroke="${cutColor}" stroke-width="2"/>
            </g>
        </g>

        <g transform="translate(${pivotX}, ${pivotY}) rotate(${rotR})">
            <g transform="translate(0, ${st.cutMode === 'top' ? -H : 0})">
                <rect x="0" y="0" width="${beamLen}" height="${H}" fill="${beamColor}" stroke="#94a3b8" filter="url(#glow)"/>
                <rect x="0" y="0" width="${beamLen}" height="${flangeTh}" fill="#94a3b8" />
                <rect x="0" y="${H-flangeTh}" width="${beamLen}" height="${flangeTh}" fill="#94a3b8" />
                 <line x1="0" y1="${H/2}" x2="${beamLen}" y2="${H/2}" stroke="#475569" stroke-dasharray="10 5"/>
                
                <line x1="0" y1="0" x2="0" y2="${H}" stroke="${cutColor}" stroke-width="2"/>
            </g>
        </g>

        <path d="M ${cx} ${pivotY + (st.cutMode==='top'?-40:40)} 
                 Q ${cx + (rotR*1.5)} ${pivotY + (st.cutMode==='top'?-40:40) + (rotR)} 
                   ${cx + Math.sin(rotR*Math.PI/180)*60} ${pivotY + (st.cutMode==='top'?-40:40)}" 
              fill="none" stroke="#38bdf8" stroke-width="2" />
              
        <text x="${cx}" y="${pivotY + (st.cutMode==='top' ? -60 : 70)}" fill="#38bdf8" font-weight="bold" text-anchor="middle" font-size="14">
            ${st.angle.toFixed(1)}°
        </text>
        
        <text x="${cx}" y="${h-20}" fill="#64748b" font-size="11" text-anchor="middle">
            النقطة الزرقاء تمثل مفصل التجميع (محور الدوران)
        </text>

      </svg>
    `;
    $canvasWrapper.innerHTML = svg;
  }

  // --- EVENTS ---
  $series.addEventListener('change', ()=>{ populateSizes(); updateUI(); });
  $size.addEventListener('change', updateUI);
  $angleRange.addEventListener('input', updateUI);
  document.querySelectorAll('input[name="cutWings"]').forEach(el => el.addEventListener('change', updateUI));
  
  $tabSingle.addEventListener('click', ()=>{ currentView='single'; $tabSingle.classList.add('tab-btn-active'); $tabJoint.classList.remove('tab-btn-active'); updateUI(); });
  $tabJoint.addEventListener('click', ()=>{ currentView='joint'; $tabJoint.classList.add('tab-btn-active'); $tabSingle.classList.remove('tab-btn-active'); updateUI(); });
  
  $btnReset.addEventListener('click', ()=>{
     $series.value = 'HEB'; populateSizes(); $size.value=180; 
     $angleRange.value=30;
     document.querySelector('input[name="cutWings"][value="top"]').checked=true;
     updateUI();
  });

  $themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('theme-dark');
    document.body.classList.toggle('theme-light');
  });

  // Init
  populateSizes();
  $size.value = 180;
  updateUI();

</script>
</body>
</html>

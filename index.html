<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø³Ø§Ø¹ØªÙŠ â€” Ù†Ø¸Ø§Ù… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„ØªØªØ¨Ù‘Ø¹ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // ØªÙ‡ÙŠØ¦Ø© TailwindCSS: Ø£Ù„ÙˆØ§Ù† ÙˆØªØ£Ø«ÙŠØ±Ø§Øª Ù…Ø­Ø³Ù‘Ù†Ø©
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Cairo', 'Inter', 'system-ui', 'ui-sans-serif'] },
          colors: {
            brand: {
              50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22'
            },
            accent: { 
              50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d', 950: '#450a0a'
            },
            ink: {
              50:'#f9fafb',100:'#f3f4f6',200:'#e5e7eb',300:'#d1d5db',400:'#9ca3af',500:'#6b7280',600:'#4b5563',700:'#374151',800:'#1f2937',900:'#111827', 950: '#030712'
            }
          },
          boxShadow: { 
            soft: '0 4px 18px rgba(0,0,0,0.06)', 
            card:'0 8px 30px rgba(2,6,23,0.08)',
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekOfYear.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_utc);dayjs.extend(window.dayjs_plugin_timezone);dayjs.extend(window.dayjs_plugin_weekOfYear);</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    html { -webkit-tap-highlight-color: transparent; }
    .container-narrow { max-width: 1200px; }
    .muted { @apply text-ink-500 dark:text-ink-300; }
    .form-input { @apply mt-1 w-full rounded-xl border border-ink-200 dark:border-ink-700 bg-white dark:bg-ink-800 px-3 py-2; }

    /* Buttons General Style */
    .btn { @apply inline-flex items-center justify-center px-5 py-3 rounded-xl font-semibold border transition shadow-soft; }
    .btn:not([disabled]):hover { @apply shadow-card -translate-y-[1px]; }
    .btn:not([disabled]):active { @apply translate-y-0 shadow-soft; }

    .btn-primary { 
      @apply bg-brand-600 text-white border-brand-600 hover:bg-brand-700 active:bg-brand-800; 
    }
    .btn-ghost { 
      @apply bg-white dark:bg-ink-800 border-ink-200 dark:border-ink-700 text-ink-700 dark:text-ink-200 hover:bg-ink-50 dark:hover:bg-ink-700; 
    }
    .btn-danger { 
      @apply bg-accent-600 text-white border-accent-600 hover:bg-accent-700 active:bg-accent-800; 
    }
    .btn-lg { @apply text-base px-6 py-3 rounded-2xl; }

    /* Card */
    .card { 
      @apply rounded-2xl border border-ink-200 dark:border-ink-800 bg-white dark:bg-ink-900 shadow-soft; 
    }

    /* ********** Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Mega Button) ********** */
    .btn-mega {
        /* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¶Ø®Ù… */
        @apply w-full flex items-center justify-center font-extrabold rounded-2xl shadow-xl transition-all;
        height: 200px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© */
        font-size: 120px; /* Ø¶Ù…Ø§Ù† Ø­Ø¬Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒØ¨ÙŠØ± */
    }
    
    /* Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø£Ø®Ø¶Ø±) */
    .btn-checkin-mega {
        @apply btn-mega bg-brand-600 border-brand-600 text-white hover:bg-brand-700 active:bg-brand-800 shadow-brand-500/50;
    }

    /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø§Ù„Ø£Ø­Ù…Ø±) */
    .btn-checkout-mega {
        @apply btn-mega bg-accent-600 border-accent-600 text-white hover:bg-accent-700 active:bg-accent-800 shadow-accent-500/50;
    }

    /* ********** Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¹Ø¨Ø± JS ********** */
    .btn-mega.opacity-30 {
        @apply opacity-30 shadow-soft cursor-not-allowed transform-none;
    }
    /* ************************************************* */

    @media print { header, .actions, footer, .log-actions { display:none!important } body{ background:#fff!important; color:#000!important } .card{ box-shadow:none!important; border:none!important } }
  </style>
</head>
<body class="bg-ink-50 text-ink-900 dark:bg-ink-950 dark:text-ink-100 font-sans">
  <div id="appRoot" class="min-h-dvh">
    <div id="app">
      <header class="sticky top-0 z-10 backdrop-blur supports-[backdrop-filter]:bg-white/80 dark:supports-[backdrop-filter]:bg-ink-950/80 border-b border-ink-200 dark:border-ink-800">
        <div class="mx-auto container-narrow px-4 py-3 flex items-center gap-3">
          <div>
            <div class="text-sm muted">Ø³Ø§Ø¹ØªÙŠ</div>
            <div class="text-lg font-bold">ØªØªØ¨Ù‘Ø¹ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
          </div>
          <div class="ms-auto flex items-center gap-2">
            <button id="themeBtn" type="button" class="btn btn-ghost" title="Ø§Ù„ÙˆØ¶Ø¹">Ø§Ù„ÙˆØ¶Ø¹</button>
            <button id="exportPdfBtn" type="button" class="btn btn-ghost" title="ØªØµØ¯ÙŠØ± PDF">PDF</button>
            <button id="exportCsvBtn" type="button" class="btn btn-primary" title="ØªØµØ¯ÙŠØ± CSV">CSV</button>
            <button id="clearBtn" type="button" class="btn btn-danger" title="Ù…Ø³Ø­">Ù…Ø³Ø­</button>
            <div id="userChip" class="ms-2 hidden items-center gap-3 px-3 py-1.5 rounded-xl bg-ink-100 dark:bg-ink-800 border border-ink-200 dark:border-ink-700">
              <div id="userAvatar" class="w-8 h-8 rounded-full bg-brand-600 grid place-items-center text-white text-sm">U</div>
              <div class="text-xs">
                <div id="userName" class="font-semibold">Guest</div>
                <div id="userEmail" class="muted"></div>
              </div>
              <button id="signOutBtn" type="button" class="btn btn-ghost text-sm py-1 px-2">Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>
        </div>
      </header>

      <main id="printArea" class="mx-auto container-narrow px-4 py-6 grid gap-6">
        
        <section class="card p-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="text-4xl font-extrabold text-ink-900 dark:text-ink-50" id="clock">--:--:--</div>
            <div class="muted" id="todayStr"></div>
            <div class="ms-auto">
              <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-ink-100 dark:bg-ink-800 border border-ink-200 dark:border-ink-700 text-sm">
                <span class="w-2.5 h-2.5 rounded-full animate-pulse" id="stateDot"></span>
                <span id="stateLabel">ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</span>
              </span>
            </div>
          </div>
          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 actions">
            <button id="checkInBtn" type="button" class="btn-checkin-mega" title="ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„">â¬†ï¸</button>
            <button id="checkOutBtn" type="button" class="btn-checkout-mega" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">â¬‡ï¸</button>
            
            <div class="col-span-1 md:col-span-2 flex flex-wrap gap-3">
                <button id="breakBtn" type="button" class="btn btn-ghost btn-lg flex-grow">Ø§Ø³ØªØ±Ø§Ø­Ø© (+15Ø¯)</button>
                <button id="editBreakBtn" type="button" class="btn btn-ghost btn-lg flex-grow">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</button>
            </div>
            
            <button id="addLeaveBtn" type="button" class="btn btn-ghost btn-lg col-span-1 md:col-span-2">ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø²Ø© ğŸ–ï¸</button>
          </div>
        </section>

        <section class="grid sm:grid-cols-2 md:grid-cols-4 gap-4">
          <div class="card p-4">
            <div class="text-sm muted">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ <span id="weekNum">â€”</span>)</div>
            <div class="mt-1 text-2xl font-bold text-brand-600" id="weekHours">0:00</div>
            <div class="text-xs muted" id="weekDays">0 ÙŠÙˆÙ… Ø¹Ù…Ù„</div>
          </div>
          <div class="card p-4">
            <div class="text-sm muted" id="monthRange">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            <div class="mt-1 text-2xl font-bold text-brand-600" id="monthHours">0:00</div>
            <div class="text-xs muted" id="monthDays">0 ÙŠÙˆÙ… Ø¹Ù…Ù„</div>
          </div>
          <div class="card p-4">
            <div class="text-sm muted">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
            <div class="mt-1 text-2xl font-bold text-blue-600 dark:text-blue-400" id="vacRemaining">â€”</div>
            <div class="text-xs muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: <span id="vacUsed">0</span> â€” Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ù†ÙˆÙŠ: <span id="vacYearDisp">24</span></div>
          </div>
          <div class="card p-4">
            <div class="text-sm muted">ÙØ±Ù‚ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©</div>
            <div class="mt-1 text-2xl font-bold" id="balanceHours">0:00</div>
            <div class="text-xs muted" id="balanceStatus">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
          </div>
        </section>

        <section class="card p-6 actions">
          <h2 class="text-lg font-semibold mb-4 border-b border-ink-200 dark:border-ink-800 pb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <label class="block col-span-1">
              <span class="text-sm muted">Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…</span>
              <input type="number" id="stdHours" step="0.25" class="form-input" value="8" />
            </label>
            <label class="block col-span-1">
              <span class="text-sm muted">Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ (ÙŠÙˆÙ…)</span>
              <input type="number" id="vacDaysYear" class="form-input" value="24" />
            </label>
            <label class="block col-span-1">
              <span class="text-sm muted">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)</span>
              <input id="currentTzDisplay" class="form-input bg-ink-100 dark:bg-ink-800/70 cursor-default" readonly />
            </label>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button id="saveSettings" type="button" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button id="addManualEntry" type="button" class="btn btn-ghost">Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ… ÙŠØ¯ÙˆÙŠ</button>
            <button id="addHolidayBtn" type="button" class="btn btn-ghost">Ø¥Ø¶Ø§ÙØ© Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©</button>
          </div>
        </section>

        <section class="card p-6 overflow-x-auto">
          <div class="flex flex-wrap items-center gap-3 mb-3 border-b border-ink-200 dark:border-ink-800 pb-2">
            <h2 class="text-lg font-semibold">Ø³Ø¬Ù„ Ø§Ù„Ø£ÙŠØ§Ù… ğŸ“…</h2>
            <div class="ms-auto flex items-center gap-2 log-actions">
              <input id="searchInput" class="form-input text-sm" placeholder="Ø¨Ø­Ø«..." />
            </div>
          </div>
          <table class="min-w-full text-sm">
            <thead class="text-left bg-ink-100 dark:bg-ink-800">
              <tr class="border-b border-ink-200 dark:border-ink-700">
                <th class="py-2 pe-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="py-2 pe-3">Ø¯Ø®ÙˆÙ„</th>
                <th class="py-2 pe-3">Ø®Ø±ÙˆØ¬</th>
                <th class="py-2 pe-3">Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¯)</th>
                <th class="py-2 pe-3">Ù…Ø¬Ù…ÙˆØ¹ (Ø³)</th>
                <th class="py-2 pe-3">Ø§Ù„Ù†ÙˆØ¹</th>
                <th class="py-2 pe-3">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="py-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr class="text-center"><td colspan="8" class="py-4 muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
            </tbody>
          </table>
        </section>

        <footer class="py-8 text-center muted text-sm">Â© <span id="year"></span> Ø³Ø§Ø¹ØªÙŠ â€” Ù…Ø­Ù„ÙŠ 100% (Local Storage)</footer>
      </main>
    </div>
  </div>

  <dialog id="modal" class="backdrop:bg-black/50 rounded-2xl p-0 w-[min(92vw,680px)] shadow-card dark:bg-ink-900 dark:text-ink-50">
    <form method="dialog" class="p-0">
      <div class="p-5 border-b border-ink-200 dark:border-ink-800 text-lg font-semibold" id="modalTitle">â€”</div>
      <div class="p-5 grid gap-4" id="modalBody"></div>
      <div class="p-4 flex justify-end gap-2 border-t border-ink-200 dark:border-ink-800">
        <button class="btn btn-ghost" value="cancel" id="modalCancel" type="submit">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" value="ok" id="modalOk" type="submit">Ø­ÙØ¸</button>
      </div>
    </form>
  </dialog>

  <script>
    // **********************************************
    // 1. DOM SELECTORS AND HELPERS
    // **********************************************
    // Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙƒÙ†Ù‚Ø·Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©
    const LOCAL_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Berlin';

    const DOM = {
        // Ø¯Ø§Ù„Ø© Ù…Ø®ØªØµØ±Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯
        get: s => document.querySelector(s),
        clock: document.getElementById('clock'),
        todayStr: document.getElementById('todayStr'),
        stateDot: document.getElementById('stateDot'),
        stateLabel: document.getElementById('stateLabel'),
        checkInBtn: document.getElementById('checkInBtn'),
        checkOutBtn: document.getElementById('checkOutBtn'),
        breakBtn: document.getElementById('breakBtn'),
        editBreakBtn: document.getElementById('editBreakBtn'), // Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        stdHours: document.getElementById('stdHours'),
        vacDaysYear: document.getElementById('vacDaysYear'),
        currentTzDisplay: document.getElementById('currentTzDisplay'),
        logBody: document.getElementById('logBody'),
        searchInput: document.getElementById('searchInput'),
        modal: document.getElementById('modal'),
        modalTitle: document.getElementById('modalTitle'),
        modalBody: document.getElementById('modalBody'),
    }

    // General Helpers
    const totalMinutes = (startISO, endISO, breaksMin=0) => Math.max(0, dayjs(endISO).diff(dayjs(startISO), 'minute') - breaksMin)
    const typeLabel = t => { return t==='work'?'Ø¹Ù…Ù„': t==='vac'?'Ø¥Ø¬Ø§Ø²Ø©': t==='sick'?'Ù…Ø±Ø¶ÙŠØ©':'Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©' }
    const now = (tz) => dayjs().tz(tz)
    const hhmm = m => { 
        const h = Math.floor(m/60)
        const mm = Math.max(0, Math.round(m%60))
        return `${h}:${mm.toString().padStart(2,'0')}` 
    }

    // **********************************************
    // 2. DataProcessor Class (State Management & Logic)
    // **********************************************

    class DataProcessor {
        constructor() {
            this.STORAGE_PREFIX = 'saati_';
            this.state = {};
            this.kpiCache = null; 
        }

        loadState() {
            try {
                this.state = {
                    lang: localStorage.getItem(this.STORAGE_PREFIX + 'lang') || 'ar',
                    theme: localStorage.getItem(this.STORAGE_PREFIX + 'theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'),
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·
                    tz: LOCAL_TZ, 
                    stdHours: +(localStorage.getItem(this.STORAGE_PREFIX + 'stdHours') || 8),
                    vacYear: +(localStorage.getItem(this.STORAGE_PREFIX + 'vacYear') || 24),
                    running: JSON.parse(localStorage.getItem(this.STORAGE_PREFIX + 'running') || 'null'),
                    logs: JSON.parse(localStorage.getItem(this.STORAGE_PREFIX + 'logs') || '[]'),
                    user: JSON.parse(localStorage.getItem(this.STORAGE_PREFIX + 'user') || 'null') || { name:'Guest', email:'', pic:'' }
                };
            } catch (e) {
                console.error("Failed to load state from localStorage", e);
                this.state = {};
            }
        }

        saveState() {
            localStorage.setItem(this.STORAGE_PREFIX + 'lang', this.state.lang);
            localStorage.setItem(this.STORAGE_PREFIX + 'theme', this.state.theme);
            localStorage.setItem(this.STORAGE_PREFIX + 'stdHours', this.state.stdHours);
            localStorage.setItem(this.STORAGE_PREFIX + 'vacYear', this.state.vacYear);
            localStorage.setItem(this.STORAGE_PREFIX + 'running', JSON.stringify(this.state.running));
            localStorage.setItem(this.STORAGE_PREFIX + 'logs', JSON.stringify(this.state.logs));
            localStorage.setItem(this.STORAGE_PREFIX + 'user', JSON.stringify(this.state.user));
            this.kpiCache = null; 
            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
            App.uiRenderer.render(); 
        }

        getState() { return this.state; }

        calculateKPIs() {
            if (this.kpiCache) return this.kpiCache;

            const today = now(this.state.tz)
            const stdMinPerDay = this.state.stdHours * 60
            const weekStart = today.startOf('week')
            const monthStart = today.startOf('month')

            const logs = this.state.logs.filter(e => e.date)
            logs.sort((a, b) => b.date.localeCompare(a.date)) 

            const weekLogs = logs.filter(e => dayjs(e.date).isAfter(weekStart.subtract(1,'day')))
            const monthLogs = logs.filter(e => dayjs(e.date).isAfter(monthStart.subtract(1,'day')))

            const sumWorkMinutes = arr => arr.reduce((a,e)=> a + (e.type==='work' ? (e.totalMin||0) : 0), 0)
            const countWorkDays = arr => arr.filter(e => e.type==='work').length

            const totWork = sumWorkMinutes(logs)
            const totDays = countWorkDays(logs)
            const usedVac = logs.filter(e=> e.type==='vac').length
            const balance = totWork - (totDays * stdMinPerDay)

            this.kpiCache = {
                weekHours: hhmm(sumWorkMinutes(weekLogs)),
                weekDays: countWorkDays(weekLogs),
                weekNum: today.week(),
                monthHours: hhmm(sumWorkMinutes(monthLogs)),
                monthDays: countWorkDays(monthLogs),
                usedVac: usedVac,
                vacRemaining: Math.max(0, this.state.vacYear - usedVac),
                balanceHours: hhmm(Math.abs(balance)),
                balanceStatus: balance > 0 ? `Ù…ØªÙ‚Ø¯Ù… Ø¨Ù€ ${hhmm(balance)} Ø¹Ù† Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ` : balance < 0 ? `Ù…ØªØ£Ø®Ø± Ø¨Ù€ ${hhmm(Math.abs(balance))} Ø¹Ù† Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†',
                filteredLogs: logs, 
            }
            return this.kpiCache
        }
        getKPIs() { return this.calculateKPIs(); }

        // *--- ACTIONS ---*
        updateSettings(stdHours, vacYear) {
            this.state.stdHours = +stdHours; 
            this.state.vacYear = +vacYear;
            this.saveState();
        }

        toggleTheme() {
            this.state.theme = this.state.theme==='dark'?'light':'dark';
            this.saveState();
        }
        
        checkIn() { 
            if (this.state.running) return; 
            this.state.running = { startISO: now(this.state.tz).toISOString(), breaksMin: 0 }; 
            this.saveState(); 
        }
        
        checkOut() {
            if (!this.state.running) return;
            const endISO = now(this.state.tz).toISOString();
            const dateStr = dayjs(this.state.running.startISO).tz(this.state.tz).format('YYYY-MM-DD');
            const totalMin = totalMinutes(this.state.running.startISO, endISO, this.state.running.breaksMin);
            this.state.logs.push({ 
                id: crypto.randomUUID(), type:'work', date: dateStr, 
                in: this.state.running.startISO, out: endISO, 
                breakMin: this.state.running.breaksMin, totalMin, note:'' 
            });
            this.state.running = null; 
            this.saveState();
        }

        addBreak(min=15) { 
            if (!this.state.running) return; 
            this.state.running.breaksMin += min; 
            this.saveState(); 
        }
        
        setBreak(min) { 
            if (!this.state.running) return; 
            this.state.running.breaksMin = Math.max(0, min); 
            this.saveState(); 
        }

        saveEntry(entry) {
            if (entry.type==='work'){
                const inISO = entry.in? dayjs(`${entry.date} ${entry.in}`).tz(this.state.tz).toISOString():null
                const outISO = entry.out? dayjs(`${entry.date} ${entry.out}`).tz(this.state.tz).toISOString():null
                entry.in = inISO; entry.out = outISO;
                entry.totalMin = (inISO && outISO)? totalMinutes(inISO, outISO, entry.breakMin||0):0
            } else { entry.in=entry.out=null; entry.breakMin=0; entry.totalMin=0 }

            const existingIndex = this.state.logs.findIndex(e=> e.id === entry.id)
            if (existingIndex > -1){ this.state.logs[existingIndex] = entry } 
            else { this.state.logs.push({...entry, id: crypto.randomUUID() }) } 
            this.saveState()
        }

        deleteEntry(id) { 
            this.state.logs = this.state.logs.filter(e=> e.id!==id); 
            this.saveState(); 
        }

        clearAll() { 
            if (confirm('ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) { 
                localStorage.clear(); 
                location.reload();
            }
        }
        
        signOut() { 
            if (confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ Ø§Ù„Ø³Ø¬Ù„).')) { 
                this.state.user = { name:'Guest', email:'', pic:'' };
                this.saveState();
            }
        }
    }
    
    // **********************************************
    // 3. UIRenderer Class (DOM Manipulation)
    // **********************************************

    class UIRenderer {
        constructor(dataStore) {
            this.dataStore = dataStore;
        }

        // *--- CORE RENDERING FUNCTIONS ---*
        render() {
            this.renderSettings();
            this.renderStatus();
            this.renderStats();
            this.renderTable();
            this.renderUser();
        }

        renderStatus() {
            const state = this.dataStore.getState();
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… tz Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            DOM.todayStr.textContent = now(state.tz).format('dddd, D MMMM YYYY');
            DOM.clock.textContent = now(state.tz).format('HH:mm:ss');
            
            // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© disabled Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
            DOM.breakBtn.disabled = !state.running;
            DOM.editBreakBtn.disabled = !state.running;
            
            // ************ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙˆØ¶ÙˆØ­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ************
            
            if (!state.running){
                // Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¹Ù…Ù„: Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø£Ø®Ø¶Ø±) ÙˆØ§Ø¶Ø­
                DOM.checkInBtn.classList.remove('opacity-30'); 
                DOM.checkOutBtn.classList.add('opacity-30');    
                
                DOM.stateDot.style.background = '#94a3b8'; DOM.stateLabel.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„';
            } else {
                // Ù†Ø´Ø·: Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø§Ù„Ø£Ø­Ù…Ø±) ÙˆØ§Ø¶Ø­
                DOM.checkInBtn.classList.add('opacity-30');    
                DOM.checkOutBtn.classList.remove('opacity-30'); 
                
                DOM.stateDot.style.background = '#10b981'; DOM.stateLabel.textContent = `Ù†Ø´ÙØ· â€” Ø§Ø³ØªØ±Ø§Ø­Ø©: ${state.running.breaksMin}Ø¯`;
            }
            // *************************************************************
        }

        renderStats() {
            const state = this.dataStore.getState();
            const kpis = this.dataStore.getKPIs();

            DOM.get('#weekHours').textContent = kpis.weekHours;
            DOM.get('#weekDays').textContent = `${kpis.weekDays} ÙŠÙˆÙ… Ø¹Ù…Ù„`;
            DOM.get('#weekNum').textContent = kpis.weekNum;
            DOM.get('#monthHours').textContent = kpis.monthHours;
            DOM.get('#monthDays').textContent = `${kpis.monthDays} ÙŠÙˆÙ… Ø¹Ù…Ù„`;

            DOM.get('#vacUsed').textContent = kpis.usedVac;
            DOM.get('#vacYearDisp').textContent = state.vacYear;
            DOM.get('#vacRemaining').textContent = kpis.vacRemaining;

            DOM.get('#balanceHours').textContent = kpis.balanceHours;
            DOM.get('#balanceHours').classList.toggle('text-red-600', kpis.balanceStatus.includes('Ù…ØªØ£Ø®Ø±'));
            DOM.get('#balanceHours').classList.toggle('text-brand-600', kpis.balanceStatus.includes('Ù…ØªÙ‚Ø¯Ù…'));
            DOM.get('#balanceStatus').textContent = kpis.balanceStatus;
        }

        renderTable() {
            const state = this.dataStore.getState();
            const logs = this.dataStore.getKPIs().filteredLogs;
            const q = (DOM.searchInput.value||'').toLowerCase();
            DOM.logBody.innerHTML = '';

            const rows = logs.filter(e => JSON.stringify(e).toLowerCase().includes(q));

            if (!rows.length){ 
                DOM.logBody.innerHTML = `<tr class="text-center"><td colspan="8" class="py-4 muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</td></tr>`; 
                return; 
            }
            
            const createCell = (html, cls='') => { 
                const td = document.createElement('td'); 
                td.className = `py-2 pe-3 ${cls}`; 
                td.innerHTML = html; 
                return td; 
            }

            rows.forEach(e => {
                const tr = document.createElement('tr'); 
                tr.className = 'border-b border-ink-200 dark:border-ink-800 hover:bg-ink-50 dark:hover:bg-ink-800/50';
                
                tr.appendChild(createCell(dayjs(e.date).tz(state.tz).format('YYYY-MM-DD (ddd)')));
                tr.appendChild(createCell(e.type==='work' ? (e.in? dayjs(e.in).tz(state.tz).format('HH:mm'):'â€”') : 'â€”'));
                tr.appendChild(createCell(e.type==='work' ? (e.out? dayjs(e.out).tz(state.tz).format('HH:mm'):'â€”') : 'â€”'));
                tr.appendChild(createCell(e.type==='work' ? (e.breakMin||0) : 'â€”'));
                tr.appendChild(createCell(e.type==='work' ? hhmm(e.totalMin||0) : 'â€”', 'font-semibold'));
                
                const typeClass = {
                    'work':'border-brand-200 text-brand-700 bg-brand-50', 
                    'vac':'border-amber-200 text-amber-800 bg-amber-50', 
                    'sick':'border-red-200 text-red-700 bg-red-50',
                    'holiday':'border-indigo-200 text-indigo-700 bg-indigo-50'
                }[e.type];
                
                tr.appendChild(createCell(`<span class="px-2 py-0.5 rounded-full text-xs font-medium border ${typeClass}">${typeLabel(e.type)}</span>`));
                tr.appendChild(createCell(e.note? `<span class="muted">${e.note}</span>`:'â€”'));
                
                const actions = document.createElement('td'); actions.className = 'py-2 log-actions'
                actions.innerHTML = `<button type="button" class="btn btn-ghost text-xs py-1 px-2" data-act="edit">ØªØ¹Ø¯ÙŠÙ„</button><button type="button" class="btn btn-danger text-xs py-1 px-2" data-act="del">Ø­Ø°Ù</button>`
                actions.querySelector('[data-act="edit"]').onclick = () => this.openEditEntry(e.id)
                actions.querySelector('[data-act="del"]').onclick = () => this.delEntry(e.id)
                tr.appendChild(actions)
                DOM.logBody.appendChild(tr)
            });
        }

        renderUser() {
            const user = this.dataStore.getState().user;
            const chip = DOM.get('#userChip');
            if (!user || user.name === 'Guest') { chip.classList.add('hidden'); return }
            chip.classList.remove('hidden');
            
            DOM.get('#userName').textContent = user.name||'Guest';
            DOM.get('#userEmail').textContent = user.email||'';
            const av = DOM.get('#userAvatar');
            
            if (user.pic){ 
                av.style.backgroundImage = `url('${user.pic}')`; 
                av.style.backgroundSize='cover'; 
                av.textContent=''; 
            } else { 
                av.style.backgroundImage='none'; 
                av.textContent=(user.name||'U')[0]; 
            }
        }

        renderSettings() {
            const state = this.dataStore.getState();
            document.documentElement.classList.toggle('dark', state.theme==='dark');
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            DOM.currentTzDisplay.value = LOCAL_TZ;

            DOM.stdHours.value = state.stdHours;
            DOM.vacDaysYear.value = state.vacYear;
            DOM.get('#year').textContent = new Date().getFullYear();
        }

        // *--- MODAL FUNCTIONS ---*
        openModal(title, bodyHTML, onOk) {
            DOM.modalTitle.textContent = title;
            DOM.modalBody.innerHTML = bodyHTML;
            DOM.modal.returnValue = '';
            DOM.modal.showModal();
            const handler = () => { 
                if (DOM.modal.returnValue === 'ok') onOk?.(); 
                DOM.modal.removeEventListener('close', handler); 
            }
            DOM.modal.addEventListener('close', handler);
        }

        openEditEntry(id){
            const state = this.dataStore.getState()
            const e = state.logs.find(x=> x.id===id); if (!e) return
            
            this.openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', `
              <label class='block'><span class='text-sm muted'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input id='em_date' type='date' class='form-input' value='${dayjs(e.date).format('YYYY-MM-DD')}'></label>
              <div class='grid grid-cols-2 gap-3'>
                <label class='block'><span class='text-sm muted'>Ø¯Ø®ÙˆÙ„</span><input id='em_in' type='time' class='form-input' value='${e.in? dayjs(e.in).tz(state.tz).format('HH:mm'):''}'></label>
                <label class='block'><span class='text-sm muted'>Ø®Ø±ÙˆØ¬</span><input id='em_out' type='time' class='form-input' value='${e.out? dayjs(e.out).tz(state.tz).format('HH:mm'):''}'></label>
              </div>
              <div class='grid grid-cols-2 gap-3'>
                <label class='block'><span class='text-sm muted'>Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¯)</span><input id='em_break' type='number' step='1' class='form-input' value='${e.breakMin||0}'></label>
                <label class='block'><span class='text-sm muted'>Ø§Ù„Ù†ÙˆØ¹</span>
                  <select id='em_type' class='form-input'>
                    <option value='work' ${e.type==='work'?'selected':''}>Ø¹Ù…Ù„</option>
                    <option value='vac' ${e.type==='vac'?'selected':''}>Ø¥Ø¬Ø§Ø²Ø©</option>
                    <option value='sick' ${e.type==='sick'?'selected':''}>Ù…Ø±Ø¶ÙŠØ©</option>
                    <option value='holiday' ${e.type==='holiday'?'selected':''}>Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©</option>
                  </select>
                </label>
              </div>
              <label class='block'><span class='text-sm muted'>Ù…Ù„Ø§Ø­Ø¸Ø©</span><input id='em_note' class='form-input' value='${e.note||''}'></label>
            `, ()=>{
                const updatedEntry = {
                    id: e.id, date: DOM.get('#em_date').value, in: DOM.get('#em_in').value,
                    out: DOM.get('#em_out').value, breakMin: +(DOM.get('#em_break').value||0),
                    type: DOM.get('#em_type').value, note: DOM.get('#em_note').value||''
                }
                this.dataStore.saveEntry(updatedEntry);
            })
        }
        
        openAddManual(){
            const d = now(this.dataStore.getState().tz).format('YYYY-MM-DD')
            this.openModal('Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ… ÙŠØ¯ÙˆÙŠ', `
              <div class='grid md:grid-cols-2 gap-3'>
                <label class='block'><span class='text-sm muted'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input id='m_date' type='date' class='form-input' value='${d}'></label>
                <label class='block'><span class='text-sm muted'>Ø§Ù„Ù†ÙˆØ¹</span>
                  <select id='m_type' class='form-input'>
                    <option value='work'>Ø¹Ù…Ù„</option><option value='vac'>Ø¥Ø¬Ø§Ø²Ø©</option><option value='sick'>Ù…Ø±Ø¶ÙŠØ©</option><option value='holiday'>Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©</option>
                  </select>
                </label>
              </div>
              <div class='grid md:grid-cols-2 gap-3'>
                <label class='block'><span class='text-sm muted'>Ø¯Ø®ÙˆÙ„</span><input id='m_in' type='time' class='form-input'></label>
                <label class='block'><span class='text-sm muted'>Ø®Ø±ÙˆØ¬</span><input id='m_out' type='time' class='form-input'></label>
              </div>
              <label class='block'><span class='text-sm muted'>Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¯)</span><input id='m_break' type='number' step='1' value='0' class='form-input'></label>
              <label class='block'><span class='text-sm muted'>Ù…Ù„Ø§Ø­Ø¸Ø©</span><input id='m_note' class='form-input'></label>
            `, ()=>{
                const newEntry = {
                    date: DOM.get('#m_date').value, type: DOM.get('#m_type').value,
                    in: DOM.get('#m_in').value, out: DOM.get('#m_out').value,
                    breakMin: +(DOM.get('#m_break').value||0), note: DOM.get('#m_note').value||''
                }
                this.dataStore.saveEntry(newEntry);
            })
        }
        
        openAddLeave(){
            const d = now(this.dataStore.getState().tz).format('YYYY-MM-DD')
            this.openModal('ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø²Ø©/Ù…Ø±Ø¶ÙŠØ©/Ø¹Ø·Ù„Ø©', `
              <label class='block'><span class='text-sm muted'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input id='l_date' type='date' class='form-input' value='${d}'></label>
              <label class='block'><span class='text-sm muted'>Ø§Ù„Ù†ÙˆØ¹</span>
                <select id='l_type' class='form-input'>
                  <option value='vac'>Ø¥Ø¬Ø§Ø²Ø©</option><option value='sick'>Ù…Ø±Ø¶ÙŠØ©</option><option value='holiday'>Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©</option>
                </select>
              </label>
              <label class='block'><span class='text-sm muted'>Ù…Ù„Ø§Ø­Ø¸Ø©</span><input id='l_note' class='form-input'></label>
            `, ()=>{
                const newEntry = {
                    date: DOM.get('#l_date').value, type: DOM.get('#l_type').value,
                    in: null, out: null, breakMin: 0, note: DOM.get('#l_note').value||''
                }
                this.dataStore.saveEntry(newEntry);
            })
        }

        openHoliday(){
            const d = now(this.dataStore.getState().tz).format('YYYY-MM-DD')
            this.openModal('Ø¥Ø¶Ø§ÙØ© Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©', `
              <label class='block'><span class='text-sm muted'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input id='h_date' type='date' class='form-input' value='${d}'></label>
              <label class='block'><span class='text-sm muted'>Ø§Ø³Ù… Ø§Ù„Ø¹Ø·Ù„Ø©</span><input id='h_note' class='form-input'></label>
            `, ()=>{
                const newEntry = {
                    date: DOM.get('#h_date').value, type: 'holiday',
                    in: null, out: null, breakMin: 0, note: DOM.get('#h_note').value||''
                }
                this.dataStore.saveEntry(newEntry);
            })
        }

        openEditBreak() {
            const running = this.dataStore.getState().running
            if (!running) return;

            this.openModal('ØªØ¹Ø¯ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©', `
              <p class="muted">ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${running.breaksMin} Ø¯Ù‚ÙŠÙ‚Ø©</strong></p>
              <label class='block'><span class='text-sm muted'>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</span>
                <input id='break_min' type='number' step='1' min='0' class='form-input' value='${running.breaksMin}'>
              </label>
            `, ()=>{
                const newBreakMin = +(DOM.get('#break_min').value||0)
                this.dataStore.setBreak(newBreakMin);
            })
        }

        delEntry(id) {
            if (confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) { 
                this.dataStore.deleteEntry(id);
            }
        }
    }

    // **********************************************
    // 4. AppController Class (Initialization & Events)
    // **********************************************

    class AppController {
        constructor(dataStore, uiRenderer) {
            this.dataStore = dataStore;
            this.uiRenderer = uiRenderer;
        }

        init() {
            this.dataStore.loadState();
            this.bindEvents();
            this.uiRenderer.render(); 
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ÙˆØ¶Ø¹ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© (ÙŠØ³ØªØ®Ø¯Ù… bind Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³ÙŠØ§Ù‚)
            setInterval(this.uiRenderer.renderStatus.bind(this.uiRenderer), 1000); 
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(this.uiRenderer.renderStats.bind(this.uiRenderer), 30000); 
        }

        bindEvents() {
            // ************ Ù…Ù†Ø·Ù‚ Ù…ÙØ¹Ø¯Ù‘ÙÙ„ Ù„Ù…ÙØ¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† opacity-30) ************
            
            DOM.checkInBtn.addEventListener('click', ()=>{
                // Ù„Ø§ ØªÙ†ÙØ° Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ø¨Ø§Ù‡ØªØ§Ù‹
                if (DOM.checkInBtn.classList.contains('opacity-30')) return; 
                this.dataStore.checkIn();
            });
            
            DOM.checkOutBtn.addEventListener('click', ()=>{
                // Ù„Ø§ ØªÙ†ÙØ° Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ø¨Ø§Ù‡ØªØ§Ù‹
                if (DOM.checkOutBtn.classList.contains('opacity-30')) return; 
                this.dataStore.checkOut();
            });
            
            // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø£Ù†Ù‡Ø§ ØªØ³ØªØ®Ø¯Ù… Ø®Ø§ØµÙŠØ© disabled Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©
            DOM.breakBtn.addEventListener('click', this.dataStore.addBreak.bind(this.dataStore));
            DOM.editBreakBtn.addEventListener('click', this.uiRenderer.openEditBreak.bind(this.uiRenderer)); 
            
            // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...

            DOM.get('#addLeaveBtn').addEventListener('click', this.uiRenderer.openAddLeave.bind(this.uiRenderer));
            DOM.get('#addManualEntry').addEventListener('click', this.uiRenderer.openAddManual.bind(this.uiRenderer));
            DOM.get('#addHolidayBtn').addEventListener('click', this.uiRenderer.openHoliday.bind(this.uiRenderer));
            DOM.get('#signOutBtn').addEventListener('click', this.dataStore.signOut.bind(this.dataStore));

            // Settings & Export
            DOM.get('#saveSettings').addEventListener('click', ()=>{
                this.dataStore.updateSettings(DOM.stdHours.value, DOM.vacDaysYear.value);
            });
            DOM.get('#exportCsvBtn').addEventListener('click', this.exportCSV.bind(this));
            DOM.get('#exportPdfBtn').addEventListener('click', this.exportPDF.bind(this));
            DOM.get('#clearBtn').addEventListener('click', this.dataStore.clearAll.bind(this.dataStore));

            // UI
            DOM.get('#themeBtn').addEventListener('click', this.dataStore.toggleTheme.bind(this.dataStore));
            DOM.get('#searchInput').addEventListener('input', this.uiRenderer.renderTable.bind(this.uiRenderer));
            
            // ******************************************************************************
        }
        
        exportCSV() {
            const state = this.dataStore.getState()
            const logs = this.dataStore.getKPIs().filteredLogs
            const header = ['date','type','in','out','break_min','total_min','note']
            const rows = [header.join(',')]
            logs.forEach(e=>{
                rows.push([
                    e.date, typeLabel(e.type),
                    e.in? dayjs(e.in).tz(state.tz).format('HH:mm'):'',
                    e.out? dayjs(e.out).tz(state.tz).format('HH:mm'):'',
                    e.breakMin||0, e.totalMin||0, (e.note||'').replaceAll(',', ';')
                ].join(','))
            })
            const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'})
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `saati_export_${dayjs().format('YYYYMMDD_HHmm')}.csv`; a.click()
        }

        async exportPDF() {
            const area = document.getElementById('printArea')
            const { jsPDF } = window.jspdf
            const pdf = new jsPDF('p','mm','a4')
            const pageWidth = 210, pageHeight = 297
            const backgroundColor = document.documentElement.classList.contains('dark') ? '#030712' : '#f9fafb'; 
            const canvas = await html2canvas(area, { scale: 2, backgroundColor: backgroundColor, windowWidth: document.body.scrollWidth, windowHeight: area.scrollHeight + 100 })
            const imgData = canvas.toDataURL('image/jpeg', 0.92)
            const imgWidth = pageWidth - 20
            const imgHeight = canvas.height * imgWidth / canvas.width
            if (imgHeight <= pageHeight - 20){ pdf.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight) }
            else {
              let consumed = 0
              while (consumed < canvas.height){
                const sliceHeight = Math.min(canvas.height - consumed, Math.floor((pageHeight-20) * canvas.width / imgWidth))
                const slice = document.createElement('canvas'); slice.width = canvas.width; slice.height = sliceHeight
                const ctx = slice.getContext('2d'); ctx.drawImage(canvas, 0, consumed, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight)
                pdf.addImage(slice.toDataURL('image/jpeg', 0.92), 'JPEG', 10, 10, imgWidth, pageHeight-20)
                consumed += sliceHeight; if (consumed < canvas.height) pdf.addPage()
              }
            }
            pdf.save(`saati_${dayjs().format('YYYYMMDD_HHmm')}.pdf`)
        }
    }

    // ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const DataStore = new DataProcessor(); 
    const UIRender = new UIRenderer(DataStore); 
    const App = new AppController(DataStore, UIRender); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ø§Ù… Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡

    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
  </script>
</body>
</html>

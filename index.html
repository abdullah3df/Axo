<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HE Cut Pro v23 — Correct Geometry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    html,body{ font-family:Cairo,system-ui,ui-sans-serif; }
    svg,svg *{user-select:none}
    body{ min-height:100vh; background:#0f172a; color:#e2e8f0; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
    input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #334155; border-radius: 5px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #38bdf8; cursor: pointer; border: 2px solid #fff; }
    .stat-box { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 8px; padding: 10px; }
    .canvas-container { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; }
  </style>
</head>
<body>

<header class="border-b border-slate-700 bg-slate-900/90 sticky top-0 z-20">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold flex gap-2 items-center">
      <span>HE Cut Pro</span>
      <span class="text-emerald-400 text-sm bg-emerald-900/30 px-2 py-0.5 rounded">v23 Corrected</span>
    </h1>
    <div class="text-xs text-slate-400">حساب القص الرأسي (Elevation)</div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6">

  <aside class="glass rounded-2xl p-5 h-fit">
    <h2 class="font-bold text-lg mb-4 text-sky-400">1. الإعدادات</h2>
    
    <div class="mb-4">
      <label class="block text-xs text-slate-400 mb-1">نوع المقطع</label>
      <div class="flex gap-2">
        <select id="series" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-2 outline-none focus:border-sky-500">
          <option value="HEA">HEA</option>
          <option value="HEB" selected>HEB</option>
          <option value="HEM">HEM</option>
        </select>
        <select id="size" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-2 outline-none focus:border-sky-500"></select>
      </div>
    </div>

    <div class="stat-box mb-4 text-xs grid grid-cols-2 gap-2">
      <div>
        <span class="block text-slate-500">الارتفاع (h)</span>
        <span id="dispH" class="font-mono text-sky-300 text-sm">--</span>
      </div>
      <div>
        <span class="block text-slate-500">العرض (b)</span>
        <span id="dispB" class="font-mono text-sky-300 text-sm">--</span>
      </div>
    </div>

    <div class="mb-5">
      <label class="block text-xs text-slate-400 mb-2">اتجاه الانحناء</label>
      <div class="flex flex-col gap-2 bg-slate-800/50 p-2 rounded border border-slate-700">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="radio" name="bendDir" value="up" checked class="accent-sky-500">
          <span class="text-sm">انحناء للأعلى (Valley)</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="radio" name="bendDir" value="down" class="accent-sky-500">
          <span class="text-sm">انحناء للأسفل (Roof)</span>
        </label>
      </div>
    </div>

    <div class="mb-6">
      <div class="flex justify-between mb-2">
        <label class="text-xs text-slate-400">زاوية التجميع (θ)</label>
        <span id="dispAngle" class="text-sky-400 font-bold text-sm">0°</span>
      </div>
      <input id="angleRange" type="range" min="0" max="60" step="0.5" value="30">
    </div>

    <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4 text-center">
      <div class="text-xs text-emerald-200/70 mb-1">قيمة القص المطلوبة (Δ)</div>
      <div id="finalCut" class="text-2xl font-bold text-emerald-400 font-mono">0.0 mm</div>
      <div class="text-[10px] text-slate-400 mt-2 leading-tight">
        يتم إزالة هذه القيمة من الجناح (العلوي أو السفلي) في كلا القطعتين لتحقيق الزاوية.
      </div>
    </div>
    
    <button id="btnReset" class="mt-4 w-full py-2 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300">إعادة تعيين</button>
  </aside>

  <section class="flex flex-col gap-4">
    
    <div class="glass rounded-2xl p-1 flex-1 min-h-[250px] flex flex-col">
      <div class="px-4 py-2 border-b border-slate-700/50 flex justify-between items-center">
        <h3 class="font-semibold text-sm text-slate-300">① وجه القطع (المقطع العرضي)</h3>
        <span class="text-[10px] text-slate-500">كيف ترى المقطع أثناء القص</span>
      </div>
      <div id="viewSection" class="flex-1 relative canvas-container rounded-b-xl"></div>
    </div>

    <div class="glass rounded-2xl p-1 flex-1 min-h-[300px] flex flex-col">
      <div class="px-4 py-2 border-b border-slate-700/50 flex justify-between items-center">
        <h3 class="font-semibold text-sm text-slate-300">② التجميع (مسقط جانبي)</h3>
        <span class="text-[10px] text-slate-500">شكل الوصلة من جانب العصب (Web)</span>
      </div>
      <div id="viewElevation" class="flex-1 relative canvas-container rounded-b-xl"></div>
    </div>

  </section>

</main>

<script>
  // أبعاد تقريبية (الارتفاع h هو الأهم هنا)
  const DB = {
    HEA: {100:{h:96,b:100}, 120:{h:114,b:120}, 140:{h:133,b:140}, 160:{h:152,b:160}, 180:{h:171,b:180}, 200:{h:190,b:200}, 220:{h:210,b:220}, 240:{h:230,b:240}, 260:{h:250,b:260}, 280:{h:270,b:280}, 300:{h:290,b:300}},
    HEB: {100:{h:100,b:100}, 120:{h:120,b:120}, 140:{h:140,b:140}, 160:{h:160,b:160}, 180:{h:180,b:180}, 200:{h:200,b:200}, 220:{h:220,b:220}, 240:{h:240,b:240}, 260:{h:260,b:260}, 280:{h:280,b:280}, 300:{h:300,b:300}},
    HEM: {100:{h:120,b:106}, 120:{h:140,b:126}, 140:{h:160,b:146}, 160:{h:180,b:166}, 180:{h:200,b:186}, 200:{h:220,b:206}, 220:{h:240,b:226}, 240:{h:270,b:248}, 260:{h:290,b:268}, 280:{h:310,b:288}, 300:{h:340,b:310}}
  };

  const $series = document.getElementById('series');
  const $size = document.getElementById('size');
  const $angle = document.getElementById('angleRange');
  
  // Update Size Options
  function popSizes(){
    const s = $series.value;
    const keys = Object.keys(DB[s]).map(Number).sort((a,b)=>a-b);
    $size.innerHTML = keys.map(k => `<option value="${k}" ${k===180?'selected':''}>${k}</option>`).join('');
    calc();
  }

  function calc(){
    const series = $series.value;
    const sz = $size.value;
    const data = DB[series][sz];
    const h = data.h;
    const b = data.b;
    const angle = parseFloat($angle.value);
    const bendDir = document.querySelector('input[name="bendDir"]:checked').value;

    // 1. الحساب الهندسي الصحيح
    // لحساب القص المطلوب لزاوية ثيتا، نستخدم ظل الزاوية مع الارتفاع
    // Cut = h * tan(theta/2) (لكل قطعة)
    const radHalf = (angle / 2) * (Math.PI / 180);
    const delta = h * Math.tan(radHalf);

    // Update UI Text
    document.getElementById('dispH').textContent = h + ' mm';
    document.getElementById('dispB').textContent = b + ' mm';
    document.getElementById('dispAngle').textContent = angle.toFixed(1) + '°';
    document.getElementById('finalCut').textContent = delta.toFixed(1) + ' mm';

    drawSection(series, sz, b, h, delta, bendDir);
    drawElevation(series, sz, b, h, angle, bendDir);
  }

  // رسم المقطع العرضي (وجه القص)
  function drawSection(s, sz, b, h, delta, dir){
    const el = document.getElementById('viewSection');
    const W = el.clientWidth || 300;
    const H_cvs = el.clientHeight || 250;
    
    // Scale Logic
    const pad = 40;
    const scale = Math.min((W-pad)/b, (H_cvs-pad)/h);
    const cx = W/2; 
    const cy = H_cvs/2;
    
    const sw = b * scale; // scaled width
    const sh = h * scale; // scaled height
    const ft = Math.max(6, sh * 0.1); // flange thickness visual
    const wt = Math.max(4, sw * 0.08); // web thickness visual
    
    // Coords relative to center
    const xL = cx - sw/2;
    const xR = cx + sw/2;
    const yT = cy - sh/2;
    const yB = cy + sh/2;

    // Highlight Logic: Which flange is cut?
    // If bending UP (Valley), top flanges touch, bottom gap opens? 
    // NO. To bend UP (ends go up), you cut the TOP flange shorter.
    // Wait, if you cut top flange shorter, and bring faces together, the beam curves UP.
    // So: UP (Valley) = Cut Top.
    // DOWN (Roof) = Cut Bottom.
    
    const cutTop = (dir === 'up');
    
    let svg = `<svg width="100%" height="100%">
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#475569"/><stop offset="1" stop-color="#1e293b"/></linearGradient>
      </defs>
      <line x1="${xL-10}" y1="${yT}" x2="${xL-10}" y2="${yB}" stroke="#64748b" />
      <text x="${xL-15}" y="${cy}" fill="#94a3b8" font-size="10" transform="rotate(-90 ${xL-15} ${cy})" text-anchor="middle">h=${h}</text>

      <path d="
        M ${xL} ${yT} H ${xR} V ${yT+ft} H ${cx+wt/2} V ${yB-ft} H ${xR} V ${yB} H ${xL} V ${yB-ft} H ${cx-wt/2} V ${yT+ft} H ${xL} Z
      " fill="url(#g1)" stroke="#94a3b8" stroke-width="1"/>
      
      ${cutTop ? 
        `<rect x="${xL}" y="${yT-2}" width="${sw}" height="${ft+4}" fill="none" stroke="#f43f5e" stroke-width="2" stroke-dasharray="4 2"/>
         <text x="${cx}" y="${yT-10}" fill="#f43f5e" font-size="12" text-anchor="middle" font-weight="bold">قص هذا الجناح (Δ)</text>` 
        : 
        `<rect x="${xL}" y="${yB-ft-2}" width="${sw}" height="${ft+4}" fill="none" stroke="#f43f5e" stroke-width="2" stroke-dasharray="4 2"/>
         <text x="${cx}" y="${yB+20}" fill="#f43f5e" font-size="12" text-anchor="middle" font-weight="bold">قص هذا الجناح (Δ)</text>`
      }
    </svg>`;
    el.innerHTML = svg;
  }

  // رسم المسقط الجانبي (التجميع)
  function drawElevation(s, sz, b, h, angle, dir){
    const el = document.getElementById('viewElevation');
    const W = el.clientWidth || 300;
    const H_cvs = el.clientHeight || 300;
    
    const cx = W/2;
    const cy = H_cvs/2;
    
    // Visual scaling
    const scale = 0.6;
    const beamLen = 140;
    const vH = h * scale; 
    const vF = Math.max(5, vH*0.1);

    // Rotation Logic
    const halfA = angle / 2;
    // If bending UP: Left rotates CCW, Right rotates CW. Pivot is at BOTTOM.
    // If bending DOWN: Left rotates CW, Right rotates CCW. Pivot is at TOP.
    
    let rotL, rotR, pivotY;
    
    if(dir === 'up') {
      pivotY = cy + vH/2; // Bottom
      rotL = -halfA;
      rotR = halfA;
    } else {
      pivotY = cy - vH/2; // Top
      rotL = halfA;
      rotR = -halfA;
    }

    const col = "#334155";
    const strk = "#64748b";

    let svg = `<svg width="100%" height="100%">
      <defs>
        <marker id="dot" markerWidth="6" markerHeight="6" refX="3" refY="3"><circle cx="3" cy="3" r="2" fill="#38bdf8"/></marker>
      </defs>
      
      <circle cx="${cx}" cy="${pivotY}" r="3" fill="#38bdf8" />

      <g transform="translate(${cx},${pivotY}) rotate(${rotL})">
        <g transform="translate(-${beamLen}, ${dir==='up' ? -vH : 0})">
          <rect x="0" y="0" width="${beamLen}" height="${vH}" fill="${col}" stroke="${strk}"/>
          <rect x="0" y="0" width="${beamLen}" height="${vF}" fill="#475569"/>
          <rect x="0" y="${vH-vF}" width="${beamLen}" height="${vF}" fill="#475569"/>
          <line x1="${beamLen}" y1="0" x2="${beamLen}" y2="${vH}" stroke="#f43f5e" stroke-width="2"/>
        </g>
      </g>

      <g transform="translate(${cx},${pivotY}) rotate(${rotR})">
        <g transform="translate(0, ${dir==='up' ? -vH : 0})">
          <rect x="0" y="0" width="${beamLen}" height="${vH}" fill="${col}" stroke="${strk}"/>
          <rect x="0" y="0" width="${beamLen}" height="${vF}" fill="#475569"/>
          <rect x="0" y="${vH-vF}" width="${beamLen}" height="${vF}" fill="#475569"/>
          <line x1="0" y1="0" x2="0" y2="${vH}" stroke="#f43f5e" stroke-width="2"/>
        </g>
      </g>

      <text x="${cx}" y="${dir==='up'? cy-40 : cy+40}" fill="#38bdf8" font-weight="bold" text-anchor="middle">${angle.toFixed(1)}°</text>

    </svg>`;
    el.innerHTML = svg;
  }

  // Events
  $series.addEventListener('change', ()=>{popSizes(); calc();});
  $size.addEventListener('change', calc);
  $angle.addEventListener('input', calc);
  document.querySelectorAll('input[name="bendDir"]').forEach(r => r.addEventListener('change', calc));
  document.getElementById('btnReset').addEventListener('click', ()=>{
    $angle.value=0; calc();
  });

  // Init
  popSizes();
  calc();

</script>
</body>
</html>

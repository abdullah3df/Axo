

const AUTH_KEY = 'work_auth';
const STATE_KEY = 'workhours_v1';
// ✨ نطاق Google Drive لإضافة ملفات التطبيق ✨
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';

// =========================================================
// 1. إدارة الحالة (State Management) و Google Handlers
// =========================================================

let state = {
    auth: null,
    sessions: [],
    vacTotal: 21,
    vacUsed: 0,
    isSyncing: false, // حالة جديدة
};

// ... (بقية دوال loadState, saveState) ...

// معالج بيانات اعتماد Google (محدث لطلب الصلاحيات)
function handleGoogleCredential(response) {
    if (response.credential) {
        // ✨ هذا هو رمز تعريف المستخدم (ID Token)، وليس رمز الوصول (Access Token) ✨
        // للحصول على رمز الوصول يجب استخدام تدفق OAuth مختلف مع الخادم الخلفي.
        bootDashboard({ method: 'google', token: response.credential, email: 'Google User' });
    }
}

// دالة تهيئة زر Google (محدثة لطلب الصلاحيات)
function initGoogleSignIn() {
    const clientId = getClientId();
    if (clientId && window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
            client_id: clientId,
            callback: handleGoogleCredential, 
            auto_select: false,
            cancel_on_tap_outside: true
        });
        
        // زر Google العادي
        google.accounts.id.renderButton(
            document.getElementById('google-btn-container'), {
                theme: 'outline',
                size: 'large',
                type: 'standard',
                shape: 'rectangular',
                locale: 'ar',
                text: 'signin_with'
            }
        );

        // ✨ تهيئة لزر المزامنة الذي يطلب الصلاحيات ✨
        google.accounts.oauth2.initCodeClient({
            client_id: clientId,
            scope: `profile email ${DRIVE_SCOPE}`, // طلب صلاحيات Drive
            ux_mode: 'popup',
            callback: (response) => {
                // ✨ هنا يتم استلام رمز التفويض (Auth Code) الذي يجب إرساله للخادم الخلفي ✨
                if (response.code) {
                    alert('نجاح! تم الحصول على رمز التفويض. يجب الآن إرساله للخادم الخلفي لإتمام المزامنة.');
                    // في بيئة حقيقية: sendCodeToServer(response.code);
                    state.auth.hasSyncPermissions = true;
                    saveState();
                    refreshDashboard();
                }
            }
        });
    } 
}

// =========================================================
// ✨ دوال المزامنة (Conceptual - تحتاج خادمًا) ✨
// =========================================================

function updateSyncButton() {
    const syncBtn = document.getElementById('sync-btn');
    if (state.auth?.method === 'google' && !state.auth?.hasSyncPermissions) {
        syncBtn.textContent = 'تفعيل مزامنة Google Drive 🔑';
        syncBtn.onclick = requestDrivePermissions;
        syncBtn.style.color = 'var(--danger)';
    } else if (state.auth?.method === 'google' && state.auth?.hasSyncPermissions) {
        syncBtn.textContent = state.isSyncing ? 'جاري المزامنة...' : 'مزامنة الآن 🔄';
        syncBtn.onclick = syncStateToDrive;
        syncBtn.style.color = 'var(--ok)';
    } else {
        syncBtn.textContent = 'المزامنة متاحة فقط لحسابات Google';
        syncBtn.onclick = null;
        syncBtn.style.color = 'var(--muted)';
    }
}

function requestDrivePermissions() {
    // تشغيل تدفق OAuth لطلب الصلاحيات المحددة
    google.accounts.oauth2.initCodeClient({
        client_id: getClientId(),
        scope: `profile email ${DRIVE_SCOPE}`,
        ux_mode: 'popup',
        callback: (response) => {
            if (response.code) {
                alert('تم الحصول على رمز التفويض (Auth Code). هذا الرمز يجب إرساله إلى خادمك الخلفي ليتم تبديله برمز وصول (Access Token) دائم لحفظ البيانات.');
                state.auth.hasSyncPermissions = true;
                saveState();
                refreshDashboard();
            }
        }
    }).requestCode();
}

function syncStateToDrive() {
    if (!state.auth || !state.auth.hasSyncPermissions) {
        return alert('الرجاء تفعيل صلاحيات المزامنة أولاً.');
    }

    // ✨ هذا الجزء تمثيلي (Placeholder) - يحتاج إلى خادم حقيقي للعمل ✨
    state.isSyncing = true;
    refreshDashboard();

    console.log("... إرسال البيانات إلى الخادم الخلفي ...");
    
    // في بيئة حقيقية:
    // fetch('/api/sync-to-google-drive', { 
    //     method: 'POST', 
    //     headers: { 'Authorization': `Bearer ${state.auth.token}` },
    //     body: JSON.stringify({ sessions: state.sessions, vacTotal: state.vacTotal, vacUsed: state.vacUsed })
    // })

    // محاكاة تأخير الشبكة
    setTimeout(() => {
        state.isSyncing = false;
        alert('نجاح: تم محاكاة حفظ البيانات في Google Drive.');
        refreshDashboard();
    }, 1500);
}

// ... (بقية دوال startSession, stopSession, getTodayTotalTime) ...

// ... (بقية دوال calculateVacation, bindVacationEvents, renderSessionHistory) ...


// دالة تحديث لوحة المراقبة (Dashboard) بالكامل
function refreshDashboard() {
    // ... (Existing logic for email, working state, etc.) ...

    // ✨ تحديث زر المزامنة ✨
    updateSyncButton(); 

    // ... (بقية Logic) ...
}

// ... (بقية دوال bootDashboard, bootWelcome, handleLogout, exportCSV) ...


window.addEventListener('DOMContentLoaded', () => {
    loadState(); 
    // تأكد من وجود خاصية hasSyncPermissions لتجنب الأخطاء
    if (state.auth && state.auth.method === 'google' && state.auth.hasSyncPermissions === undefined) {
        state.auth.hasSyncPermissions = false;
    }
    
    if (state.auth) {
        bootDashboard();
    } else {
        bootWelcome();
    }
});

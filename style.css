

const AUTH_KEY = 'work_auth';
const STATE_KEY = 'workhours_v1';
// âœ¨ Ù†Ø·Ø§Ù‚ Google Drive Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ¨
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';

// =========================================================
// 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© (State Management) Ùˆ Google Handlers
// =========================================================

let state = {
    auth: null,
    sessions: [],
    vacTotal: 21,
    vacUsed: 0,
    isSyncing: false, // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
};

// ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ loadState, saveState) ...

// Ù…Ø¹Ø§Ù„Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Google (Ù…Ø­Ø¯Ø« Ù„Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)
function handleGoogleCredential(response) {
    if (response.credential) {
        // âœ¨ Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ù…Ø² ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID Token)ØŒ ÙˆÙ„ÙŠØ³ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (Access Token) âœ¨
        // Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ¯ÙÙ‚ OAuth Ù…Ø®ØªÙ„Ù Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ.
        bootDashboard({ method: 'google', token: response.credential, email: 'Google User' });
    }
}

// Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Google (Ù…Ø­Ø¯Ø«Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)
function initGoogleSignIn() {
    const clientId = getClientId();
    if (clientId && window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
            client_id: clientId,
            callback: handleGoogleCredential, 
            auto_select: false,
            cancel_on_tap_outside: true
        });
        
        // Ø²Ø± Google Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        google.accounts.id.renderButton(
            document.getElementById('google-btn-container'), {
                theme: 'outline',
                size: 'large',
                type: 'standard',
                shape: 'rectangular',
                locale: 'ar',
                text: 'signin_with'
            }
        );

        // âœ¨ ØªÙ‡ÙŠØ¦Ø© Ù„Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙŠ ÙŠØ·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª âœ¨
        google.accounts.oauth2.initCodeClient({
            client_id: clientId,
            scope: `profile email ${DRIVE_SCOPE}`, // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Drive
            ux_mode: 'popup',
            callback: (response) => {
                // âœ¨ Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ù…Ø² Ø§Ù„ØªÙÙˆÙŠØ¶ (Auth Code) Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ âœ¨
                if (response.code) {
                    alert('Ù†Ø¬Ø§Ø­! ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ØªÙÙˆÙŠØ¶. ÙŠØ¬Ø¨ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
                    // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©: sendCodeToServer(response.code);
                    state.auth.hasSyncPermissions = true;
                    saveState();
                    refreshDashboard();
                }
            }
        });
    } 
}

// =========================================================
// âœ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Conceptual - ØªØ­ØªØ§Ø¬ Ø®Ø§Ø¯Ù…Ù‹Ø§) âœ¨
// =========================================================

function updateSyncButton() {
    const syncBtn = document.getElementById('sync-btn');
    if (state.auth?.method === 'google' && !state.auth?.hasSyncPermissions) {
        syncBtn.textContent = 'ØªÙØ¹ÙŠÙ„ Ù…Ø²Ø§Ù…Ù†Ø© Google Drive ðŸ”‘';
        syncBtn.onclick = requestDrivePermissions;
        syncBtn.style.color = 'var(--danger)';
    } else if (state.auth?.method === 'google' && state.auth?.hasSyncPermissions) {
        syncBtn.textContent = state.isSyncing ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...' : 'Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù† ðŸ”„';
        syncBtn.onclick = syncStateToDrive;
        syncBtn.style.color = 'var(--ok)';
    } else {
        syncBtn.textContent = 'Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨Ø§Øª Google';
        syncBtn.onclick = null;
        syncBtn.style.color = 'var(--muted)';
    }
}

function requestDrivePermissions() {
    // ØªØ´ØºÙŠÙ„ ØªØ¯ÙÙ‚ OAuth Ù„Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    google.accounts.oauth2.initCodeClient({
        client_id: getClientId(),
        scope: `profile email ${DRIVE_SCOPE}`,
        ux_mode: 'popup',
        callback: (response) => {
            if (response.code) {
                alert('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ØªÙÙˆÙŠØ¶ (Auth Code). Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù…Ùƒ Ø§Ù„Ø®Ù„ÙÙŠ Ù„ÙŠØªÙ… ØªØ¨Ø¯ÙŠÙ„Ù‡ Ø¨Ø±Ù…Ø² ÙˆØµÙˆÙ„ (Access Token) Ø¯Ø§Ø¦Ù… Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                state.auth.hasSyncPermissions = true;
                saveState();
                refreshDashboard();
            }
        }
    }).requestCode();
}

function syncStateToDrive() {
    if (!state.auth || !state.auth.hasSyncPermissions) {
        return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹.');
    }

    // âœ¨ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ØªÙ…Ø«ÙŠÙ„ÙŠ (Placeholder) - ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø¹Ù…Ù„ âœ¨
    state.isSyncing = true;
    refreshDashboard();

    console.log("... Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ ...");
    
    // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©:
    // fetch('/api/sync-to-google-drive', { 
    //     method: 'POST', 
    //     headers: { 'Authorization': `Bearer ${state.auth.token}` },
    //     body: JSON.stringify({ sessions: state.sessions, vacTotal: state.vacTotal, vacUsed: state.vacUsed })
    // })

    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ± Ø§Ù„Ø´Ø¨ÙƒØ©
    setTimeout(() => {
        state.isSyncing = false;
        alert('Ù†Ø¬Ø§Ø­: ØªÙ… Ù…Ø­Ø§ÙƒØ§Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Drive.');
        refreshDashboard();
    }, 1500);
}

// ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ startSession, stopSession, getTodayTotalTime) ...

// ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ calculateVacation, bindVacationEvents, renderSessionHistory) ...


// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (Dashboard) Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function refreshDashboard() {
    // ... (Existing logic for email, working state, etc.) ...

    // âœ¨ ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ¨
    updateSyncButton(); 

    // ... (Ø¨Ù‚ÙŠØ© Logic) ...
}

// ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ bootDashboard, bootWelcome, handleLogout, exportCSV) ...


window.addEventListener('DOMContentLoaded', () => {
    loadState(); 
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø§ØµÙŠØ© hasSyncPermissions Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    if (state.auth && state.auth.method === 'google' && state.auth.hasSyncPermissions === undefined) {
        state.auth.hasSyncPermissions = false;
    }
    
    if (state.auth) {
        bootDashboard();
    } else {
        bootWelcome();
    }
});
